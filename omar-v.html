<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ESS • Weekly Chart (Mon–Sun)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{margin:0;padding:0;background:#f7f7fb;color:#0f172a}
    *,*::before,*::after{box-sizing:border-box}
    .row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
    .row > *{min-width:240px;flex:1}
    .weekbar{display:flex;align-items:center;gap:12px;border:1px solid #e5e7eb;padding:10px;border-radius:10px;background:#f8fafc;flex-wrap:wrap}
    .weekbar .spacer{flex:1 1 auto;min-width:60px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn--primary{border-color:#2c3e50;background:#2c3e50;color:#fff}
    .btn--dark{border-color:#1f2937;background:#1f2937;color:#fff}
    .btn--icon{width:36px;height:36px}
    .daybtn{position:relative;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;cursor:pointer;width:100%;text-align:left}
    .dot{position:absolute;right:10px;top:10px;width:8px;height:8px;border-radius:999px;background:#e5e7eb}
    .input,.select,.textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    .textarea{min-height:120px;resize:vertical}
    .label{display:block;color:#6b7280;font-size:12px;margin-bottom:6px}
    .pill{font-size:12px;background:#eef2ff;border:1px solid #e5e7eb;padding:6px 10px;border-radius:999px;color:#0f172a}
    #w_toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.2);z-index:1000;font-size:14px;opacity:0;transition:opacity .25s}
    #w_error{display:none;margin-top:12px;padding:10px;border-radius:8px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b}
    .sig-wrap{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:14px;padding:18px;margin-top:14px;}
    .sig-title{font-weight:600;margin-bottom:8px;}
    .sig-box{border:1px dashed #d1d5db;border-radius:10px;background:#fff;}
    canvas.sig{width:100%;height:140px;display:block;border-radius:10px;touch-action:none;cursor:crosshair;}
  </style>
</head>
<body>
<section style="max-width:980px;margin:2rem auto;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06);font-family:sans-serif;border:1px solid #e5e7eb;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px;">
    <h2 style="margin:0;">📅 Weekly Chart (Mon–Sun)</h2>
    <!-- ✅ now enabled -->
    <button id="w_submitWeek" class="btn btn--primary">
      Submit Weekly Report
    </button>
  </div>

  <div class="row" style="margin-bottom:10px;">
    <input type="hidden" id="client_id" value="521dd725-2fa6-4d78-9fcc-e5447dc727cb" />
    <div>
      <label for="staff_id" class="label">Staff (type your name)</label>
      <input id="staff_id" type="text" class="input" placeholder="e.g., Maria Perez" required />
    </div>
    <span class="pill">Drafts: server + local</span>
  </div>

  <div class="weekbar">
    <button id="w_prevWeek" aria-label="Previous week" class="btn btn--icon">◀</button>
    <div>
      <div id="w_range" style="font-weight:700;color:#0f172a;">Mon — Sun</div>
      <div style="color:#6b7280;font-size:13px;">Week of <span id="w_startTxt"></span> to <span id="w_endTxt"></span></div>
    </div>
    <button id="w_nextWeek" aria-label="Next week" class="btn btn--icon">▶</button>
    <div class="spacer"></div>
  </div>

  <div id="w_days" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-top:14px;"></div>

  <div id="w_panel" style="display:none;margin-top:12px;border-top:1px solid #e5e7eb;padding-top:12px;">
    <div id="w_panelDate" style="color:#6b7280;margin-bottom:10px;"></div>

    <div class="row">
      <div>
        <label for="w_start" class="label">Start Time</label>
        <input id="w_start" type="time" class="input">
      </div>
      <div>
        <label for="w_end" class="label">End Time</label>
        <input id="w_end" type="time" class="input">
      </div>
      <div>
        <label for="w_modality" class="label">Modality / Location</label>
        <select id="w_modality" class="select">
          <option value="Home">Home</option>
          <option value="Community">Community</option>
          <option value="Remote" selected>Remote</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label for="w_hours" class="label">Hours Worked</label>
        <input id="w_hours" type="number" min="0" step="0.25" placeholder="e.g., 3.5" class="input">
      </div>
      <div>
        <label for="w_domain" class="label">Domain (service codes worked on)</label>
        <input id="w_domain" type="text" placeholder="e.g., Money Mgmt, Hygiene, Safety…" class="input">
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label for="w_rc" class="label">Regional Center</label>
        <input id="w_rc" type="text" class="input" placeholder="e.g., SG/PRC">
      </div>
      <div>
        <label for="w_sc" class="label">Service Coordinator</label>
        <input id="w_sc" type="text" class="input" placeholder="e.g., Imani T.">
      </div>
    </div>

    <div style="margin-top:12px;">
      <label for="w_notes" class="label">Progress Notes</label>
      <textarea id="w_notes" class="textarea" placeholder="what/where/with whom, goals"></textarea>
    </div>

    <div style="margin-top:12px;">
      <label for="w_obs" class="label">Observation</label>
      <textarea id="w_obs" class="textarea" placeholder="reaction/response to today's services"></textarea>
    </div>

    <div style="margin-top:12px;">
      <label for="w_plan" class="label">Action Plan</label>
      <textarea id="w_plan" class="textarea" placeholder="next steps to work on the service codes"></textarea>
    </div>

    <div class="sig-wrap">
      <div style="display:flex;gap:20px;flex-wrap:wrap;">
        <div style="flex:1;min-width:240px;">
          <div class="sig-title">Staff Signature</div>
          <div class="sig-box">
            <canvas id="staffSig" class="sig"></canvas>
          </div>
          <div style="font-size:12px;color:#6b7280;margin-top:6px;">Draw with mouse/finger.</div>
          <button id="clearStaffSig" class="btn" style="margin-top:8px;">Clear Staff Signature</button>
        </div>
        <div style="flex:1;min-width:240px;">
          <div class="sig-title">Client / Parent / Authorized Signature</div>
          <div class="sig-box">
            <canvas id="clientSig" class="sig"></canvas>
          </div>
          <div style="font-size:12px;color:#6b7280;margin-top:6px;">Draw with mouse/finger.</div>
          <button id="clearClientSig" class="btn" style="margin-top:8px;">Clear Client Signature</button>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
      <button id="w_clearDay" class="btn">Clear Day</button>
      <button id="w_saveDay"  class="btn btn--dark">Save Day (Draft)</button>
      <button id="w_submitDay" class="btn btn--primary">Submit Day (Official)</button>
    </div>
  </div>

  <div id="w_error"></div>
  <div id="w_toast"></div>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  try {
    const SUPABASE_URL = "https://bqanjupmcgydvmfgvutx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYW5qdXBtY2d5ZHZtZmd2dXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTI4NzQsImV4cCI6MjA3NjM4ODg3NH0.J3A12rwUlSqjIsmlnNCcwis6Qt_ryw7ZzFqLftuMKUk";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const ess = sb.schema("ess");

    const $ = (id)=>document.getElementById(id);
    const CLIENT_ID_INPUT = $("client_id");
    const STAFF_INPUT     = $("staff_id");

    const w_days=$("w_days"), w_range=$("w_range"), w_startTxt=$("w_startTxt"), w_endTxt=$("w_endTxt");
    const w_prevWeek=$("w_prevWeek"), w_nextWeek=$("w_nextWeek");
    const w_panel=$("w_panel"), w_panelDate=$("w_panelDate");
    const w_start=$("w_start"), w_end=$("w_end"), w_modality=$("w_modality");
    const w_hours=$("w_hours"), w_domain=$("w_domain"), w_notes=$("w_notes");
    const w_obs=$("w_obs"), w_plan=$("w_plan");
    const w_rc=$("w_rc"), w_sc=$("w_sc");
    const w_saveDay=$("w_saveDay"), w_clearDay=$("w_clearDay"), w_submitDay=$("w_submitDay");
    const w_submitWeek = $("w_submitWeek");
    const w_toast=$("w_toast"), w_error=$("w_error");

    const staffSigCanvas = $("staffSig");
    const clientSigCanvas = $("clientSig");
    let staffSigData = null, clientSigData = null;

    function initSignatureCanvas(canvas){
      const box = canvas.getBoundingClientRect();
      const ratio = window.devicePixelRatio || 1;
      canvas.width  = box.width * ratio;
      canvas.height = 140 * ratio;
      const ctx = canvas.getContext('2d');
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(ratio, ratio);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#000";
      return ctx;
    }

    let staffSigCtx = initSignatureCanvas(staffSigCanvas);
    let clientSigCtx = initSignatureCanvas(clientSigCanvas);

    function makeDrawable(canvas, ctx, onEnd){
      let drawing = false;
      function getPos(e){
        const r = canvas.getBoundingClientRect();
        const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
        const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
        return {x,y};
      }
      function down(e){ e.preventDefault(); drawing = true; const p = getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); }
      function move(e){ if(!drawing) return; const p = getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); }
      function up(){ if(!drawing) return; drawing=false; if(onEnd) onEnd(canvas); }

      canvas.addEventListener("pointerdown", down);
      canvas.addEventListener("pointermove", move);
      window.addEventListener("pointerup", up);
      canvas.addEventListener("touchstart", down, {passive:false});
      canvas.addEventListener("touchmove", move, {passive:false});
      canvas.addEventListener("touchend", up);
    }

    function captureCanvasData(c){ return c.toDataURL("image/png"); }

    makeDrawable(staffSigCanvas, staffSigCtx, (c)=>{ staffSigData = captureCanvasData(c); });
    makeDrawable(clientSigCanvas, clientSigCtx, (c)=>{ clientSigData = captureCanvasData(c); });

    $("clearStaffSig").addEventListener("click",()=>{
      staffSigCtx.clearRect(0,0,staffSigCanvas.width,staffSigCanvas.height);
      staffSigData = null;
    });
    $("clearClientSig").addEventListener("click",()=>{
      clientSigCtx.clearRect(0,0,clientSigCanvas.width,clientSigCanvas.height);
      clientSigData = null;
    });

    window.addEventListener("resize", ()=>{
      staffSigCtx = initSignatureCanvas(staffSigCanvas);
      clientSigCtx = initSignatureCanvas(clientSigCanvas);
      // don't wipe saved data on resize
      if (staffSigData){
        const img = new Image();
        img.onload = ()=> staffSigCtx.drawImage(img,0,0,staffSigCanvas.width/(window.devicePixelRatio||1),140);
        img.src = staffSigData;
      }
      if (clientSigData){
        const img = new Image();
        img.onload = ()=> clientSigCtx.drawImage(img,0,0,clientSigCanvas.width/(window.devicePixelRatio||1),140);
        img.src = clientSigData;
      }
    });

    function toast(m){w_toast.textContent=m;w_toast.style.opacity='1';setTimeout(()=>w_toast.style.opacity='0',1600);}
    const fmt = (d)=>new Intl.DateTimeFormat('en-US',{month:'short',day:'2-digit',year:'numeric'}).format(d);
    const ymd = (d)=>d.toISOString().slice(0,10);
    function startOfWeekMonday(d){const nd=new Date(d.getFullYear(),d.getMonth(),d.getDate());const day=nd.getDay();const diff=(day===0?-6:1-day);nd.setDate(nd.getDate()+diff);nd.setHours(0,0,0,0);return nd;}
    function addDays(d,n){const nd=new Date(d);nd.setDate(nd.getDate()+n);return nd;}

    const getClientId  = ()=> CLIENT_ID_INPUT.value;
    const getStaffName = ()=> (STAFF_INPUT.value || "").replace(/\s+/g,' ').trim();
    const isUuid = (s)=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);

    const staffUuidCache = new Map();

    async function getOrCreateStaffUuid() {
      const nameOrId = getStaffName();
      if (!nameOrId) return null;
      if (isUuid(nameOrId)) return nameOrId;
      if (staffUuidCache.has(nameOrId)) return staffUuidCache.get(nameOrId);

      let { data, error } = await ess.from("staff").select("id, full_name").eq("full_name", nameOrId).maybeSingle();
      if (!error && data?.id) {
        staffUuidCache.set(nameOrId, data.id);
        return data.id;
      }

      ({ data, error } = await ess.from("staff").select("id, full_name").ilike("full_name", `%${nameOrId}%`).limit(1).maybeSingle());
      if (!error && data?.id) {
        staffUuidCache.set(nameOrId, data.id);
        return data.id;
      }

      const newId = (crypto && crypto.randomUUID) ? crypto.randomUUID() :
        'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
          const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
        });

      const insert = await ess.from("staff").insert([{ id: newId, full_name: nameOrId }]).select("id").maybeSingle();
      if (insert.error) throw new Error(`Could not add staff "${nameOrId}". (${insert.error.message})`);

      const resolved = insert.data?.id || newId;
      staffUuidCache.set(nameOrId, resolved);
      return resolved;
    }

    let current = startOfWeekMonday(new Date());
    let activeIndex = null;

    const dayKey  = (wk,i)=>`essWeek_${getClientId()}_${getStaffName()}_${ymd(wk)}_d${i}`;

    async function fetchDraft(i){
      try{
        const staffUuid = await getOrCreateStaffUuid();
        if(!staffUuid) return null;
        const { data } = await ess.from("daily_drafts")
          .select("hours, activities, notes, date, submitted, start_time, end_time, modality, staff_signature, client_signature, regional_center, service_coordinator")
          .eq("client_id", getClientId()).eq("staff_id", staffUuid)
          .eq("week_start", ymd(current)).eq("day_index", i).maybeSingle();
        return data||null;
      }catch{ return null; }
    }

    async function upsertDraft(i, payload){
      try{
        const staffUuid = await getOrCreateStaffUuid();
        if(!staffUuid) { toast('Type a valid Staff name'); return; }
        const body = {
          client_id:getClientId(), staff_id:staffUuid,
          week_start: ymd(current), day_index: i, date: payload.date,
          hours: payload.hours!==''? Number(payload.hours):null,
          activities: payload.activities||null,
          notes: payload.notes || null,
          start_time: payload.start_time||null, end_time: payload.end_time||null,
          modality: payload.modality||'Remote',
          staff_signature: payload.staff_signature || null,
          client_signature: payload.client_signature || null,
          regional_center: payload.regional_center || null,
          service_coordinator: payload.service_coordinator || null,
          submitted: false
        };
        await ess.from("daily_drafts").upsert(body, { onConflict: "client_id,staff_id,week_start,day_index" });
      }catch(e){ console.warn("Upsert draft failed:", e); }
    }

    async function insertDailyEntry(payload){
      const staffUuid = await getOrCreateStaffUuid();
      if(!staffUuid) throw new Error('Type a valid Staff name');
      const raw  = (payload.activities||"").trim();
      const acts = raw ? [raw] : null;

      const entryBase = {
        client_id: getClientId(),
        staff_id:  staffUuid,
        service_date: payload.date,
        start_time: payload.start_time || null,
        end_time:   payload.end_time   || null,
        modality:   payload.modality   || 'Remote',
        service_notes: payload.notes || null,
        activities: acts,
        staff_signature: payload.staff_signature || null,
        client_signature: payload.client_signature || null,
        regional_center: payload.regional_center || null,
        service_coordinator: payload.service_coordinator || null,
        signed_at: new Date().toISOString()
      };

      let { error } = await ess.from("daily_entries").insert(entryBase);
      if (error && String(error.message||'').includes('activities_allowed')) {
        ({ error } = await ess.from("daily_entries").insert({ ...entryBase, activities: null }));
      }
      if (error) throw error;
    }

    function markDots(){
      for(let i=0;i<7;i++){
        const dot = document.getElementById(`w_dot${i}`);
        const has = localStorage.getItem(dayKey(current,i));
        if(dot){ dot.style.background = has ? '#22c55e' : '#e5e7eb'; }
      }
    }

    function renderWeek(){
      const start=new Date(current), end=addDays(start,6);
      w_startTxt.textContent=fmt(start); w_endTxt.textContent=fmt(end);
      w_range.textContent=`Mon ${start.getDate()} — Sun ${end.getDate()}`;

      const names=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
      w_days.innerHTML='';
      for(let i=0;i<7;i++){
        const d = addDays(start,i);
        const btn = document.createElement('button');
        btn.type='button';
        btn.className='daybtn';
        btn.innerHTML=`
          <div style="font-size:12px;color:#6b7280;">${names[i]}</div>
          <div style="font-size:16px;font-weight:800;color:#0f172a;">${d.getDate()}</div>
          <div id="w_dot${i}" class="dot"></div>
        `;
        btn.addEventListener('click',()=>openDay(i));
        w_days.appendChild(btn);
      }
      markDots();

      const today=new Date(); 
      const inRange=+today>=+start && +today<=+end;
      openDay(inRange ? (today.getDay()===0?6:today.getDay()-1) : 0);
    }

    function parseMergedNotes(text){
      const out = { notes:'', obs:'', plan:'' };
      if(!text) return out;
      const N='## Progress Notes:', O='## Observation:', P='## Action Plan:';
      if(text.includes(N)){
        const nIdx=text.indexOf(N)+N.length;
        const oIdx=text.indexOf(O, nIdx);
        const pIdx=text.indexOf(P, oIdx>-1?oIdx:nIdx);
        out.notes = text.slice(nIdx, oIdx>-1?oIdx: (pIdx>-1?pIdx:text.length)).trim();
        if(oIdx>-1){ out.obs = text.slice(oIdx+O.length, pIdx>-1?pIdx:text.length).trim(); }
        if(pIdx>-1){ out.plan = text.slice(pIdx+P.length).trim(); }
        return out;
      }
      out.notes = text; return out;
    }

    function mergeNotes(notes, obs, plan){
      return [
        "## Progress Notes:\n" + (notes||"").trim(),
        "## Observation:\n" + (obs||"").trim(),
        "## Action Plan:\n" + (plan||"").trim(),
      ].join("\n\n").trim();
    }

    async function openDay(i){
      activeIndex=i; 
      w_error.style.display='none'; 
      [...w_days.children].forEach((el,idx)=>{ el.style.outline=(idx===i)?'2px solid #0ea5e9':'none'; });

      const d=addDays(current,i);
      w_panelDate.textContent=`${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i]} — ${fmt(d)}`;

      const srv=await fetchDraft(i);
      if(srv){
        w_hours.value = srv.hours ?? '';
        w_domain.value= srv.activities ?? '';
        const parsed = parseMergedNotes(srv.notes ?? '');
        w_notes.value = parsed.notes ?? '';
        w_obs.value   = parsed.obs ?? '';
        w_plan.value  = parsed.plan ?? '';
        w_start.value = srv.start_time ?? '';
        w_end.value   = srv.end_time ?? '';
        w_modality.value = srv.modality ?? 'Remote';
        w_rc.value = srv.regional_center ?? '';
        w_sc.value = srv.service_coordinator ?? '';

        staffSigData = srv.staff_signature || null;
        clientSigData = srv.client_signature || null;
        repaintSig();
      }else{
        const raw=localStorage.getItem(dayKey(current,i));
        if(raw){
          try{
            const obj=JSON.parse(raw);
            w_hours.value = obj.hours ?? '';
            w_domain.value= obj.domain ?? (obj.activities ?? '');
            w_notes.value = obj.notes_only ?? obj.notes ?? '';
            w_obs.value   = obj.observation ?? '';
            w_plan.value  = obj.action_plan ?? '';
            w_start.value = obj.start_time ?? '';
            w_end.value   = obj.end_time ?? '';
            w_modality.value = obj.modality ?? 'Remote';
            w_rc.value = obj.regional_center ?? '';
            w_sc.value = obj.service_coordinator ?? '';
            staffSigData = obj.staff_signature || null;
            clientSigData = obj.client_signature || null;
            repaintSig();
          }catch{
            resetDay();
          }
        }else{
          resetDay();
        }
      }
      w_panel.style.display='block';
    }

    function repaintSig(){
      staffSigCtx.clearRect(0,0,staffSigCanvas.width,staffSigCanvas.height);
      clientSigCtx.clearRect(0,0,clientSigCanvas.width,clientSigCanvas.height);
      if (staffSigData){
        const img = new Image();
        img.onload = ()=> staffSigCtx.drawImage(img,0,0,staffSigCanvas.width/(window.devicePixelRatio||1),140);
        img.src = staffSigData;
      }
      if (clientSigData){
        const img = new Image();
        img.onload = ()=> clientSigCtx.drawImage(img,0,0,clientSigCanvas.width/(window.devicePixelRatio||1),140);
        img.src = clientSigData;
      }
    }

    function resetDay(){
      w_hours.value=w_domain.value=w_notes.value=w_obs.value=w_plan.value=w_start.value=w_end.value='';
      w_modality.value='Remote';
      w_rc.value = '';
      w_sc.value = '';
      staffSigData = clientSigData = null;
      repaintSig();
    }

    function buildPayload(){
      const notesMerged = mergeNotes((w_notes.value||''),(w_obs.value||''),(w_plan.value||''));
      return {
        date: ymd(addDays(current,activeIndex)),
        hours: (w_hours.value||''),
        activities: (w_domain.value||''),
        notes: notesMerged,
        notes_only: (w_notes.value||''),
        observation: (w_obs.value||''),
        action_plan: (w_plan.value||''),
        start_time: (w_start.value||''),
        end_time: (w_end.value||''),
        modality: (w_modality.value||'Remote'),
        regional_center: (w_rc.value || ''),
        service_coordinator: (w_sc.value || ''),
        staff_signature: staffSigData || null,
        client_signature: clientSigData || null
      };
    }

    async function saveDay(){
      if(activeIndex==null) return;
      if(!getStaffName()){ toast('Type Staff name first'); return; }

      try{ await getOrCreateStaffUuid(); }
      catch(e){ 
        w_error.style.display='block'; 
        w_error.textContent = e.message; 
        toast('Staff error ❌'); 
        return; 
      }

      const payload = buildPayload();
      localStorage.setItem(dayKey(current,activeIndex), JSON.stringify({ ...payload, domain: payload.activities }));
      markDots();
      await upsertDraft(activeIndex, payload);
      toast('Day saved (draft) ✓');
    }

    function clearDay(){
      if(activeIndex==null) return;
      localStorage.removeItem(dayKey(current,activeIndex));
      resetDay();
      markDots();
      toast('Day cleared locally. Server draft remains until overwritten.');
    }

    async function submitDay(){
      if(activeIndex==null) return;
      if(!getStaffName()){ toast('Type Staff name first'); return; }

      const payload = buildPayload();
      try{
        await insertDailyEntry(payload);
        await upsertDraft(activeIndex, payload);
        localStorage.setItem(dayKey(current,activeIndex), JSON.stringify({ ...payload, domain: payload.activities }));
        markDots();
        toast('Day submitted (official) ✅');
      }catch(e){
        console.error('Submit error:', e);
        w_error.style.display='block';
        w_error.textContent = 'Submit failed: ' + (e?.message || 'Unknown error');
        toast('Submit failed ❌');
      }
    }

    async function submitWeek(){
      if(!getStaffName()){
        toast('Type Staff name first');
        return;
      }
      let staffUuid;
      try {
        staffUuid = await getOrCreateStaffUuid();
      } catch (e) {
        w_error.style.display='block';
        w_error.textContent = e.message;
        return;
      }

      const weekStart = ymd(current);
      const entries = [];
      const names = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];

      for (let i=0;i<7;i++){
        let srv = await fetchDraft(i);
        if (!srv){
          const raw = localStorage.getItem(dayKey(current,i));
          if (raw){
            try {
              const obj = JSON.parse(raw);
              srv = {
                date: obj.date || ymd(addDays(current,i)),
                hours: obj.hours || '',
                activities: obj.activities || obj.domain || '',
                notes: mergeNotes(obj.notes_only||obj.notes||'', obj.observation||'', obj.action_plan||''),
                start_time: obj.start_time || '',
                end_time: obj.end_time || '',
                modality: obj.modality || 'Remote',
                regional_center: obj.regional_center || '',
                service_coordinator: obj.service_coordinator || '',
                staff_signature: obj.staff_signature || null,
                client_signature: obj.client_signature || null
              };
            } catch {}
          }
        }
        if (srv){
          // ✅ match admin portal format
          const hrsNum = srv.hours ? Number(srv.hours) : null;
          entries.push({
            dayIndex: i,
            label: names[i],
            date: srv.date || ymd(addDays(current,i)),
            start_time: srv.start_time || "",
            end_time: srv.end_time || "",
            hours: hrsNum !== null && !Number.isNaN(hrsNum) ? hrsNum : null,
            modality: srv.modality || "Remote",
            domain: srv.activities || "",
            notes: srv.notes || "",
            staff_signature: srv.staff_signature || "",
            client_signature: srv.client_signature || "",
            regional_center: srv.regional_center || "",
            service_coordinator: srv.service_coordinator || "",
            source: "weekly"     // 👈 admin will now see source==="weekly"
          });
        }
      }

      if (!entries.length){
        toast('No days to submit ❌');
        return;
      }

      const { error } = await ess.from("weekly_reports")
        .upsert({
          client_id: getClientId(),
          staff_id: staffUuid,
          week_start: weekStart,
          entries: entries,
          submitted_at: new Date().toISOString()
        }, { onConflict: "client_id,staff_id,week_start" });

      if (error){
        console.error(error);
        w_error.style.display='block';
        w_error.textContent = 'Weekly submit failed: ' + error.message;
        toast('Weekly submit failed ❌');
        return;
      }

      toast('Weekly report submitted ✅');
    }

    function shiftWeek(delta){ current=addDays(current,7*delta); renderWeek(); }

    w_prevWeek.addEventListener('click',()=>shiftWeek(-1));
    w_nextWeek.addEventListener('click',()=>shiftWeek(1));
    w_saveDay.addEventListener('click',saveDay);
    w_clearDay.addEventListener('click',clearDay);
    w_submitDay.addEventListener('click',submitDay);
    w_submitWeek.addEventListener('click',submitWeek);

    renderWeek();
  } catch (e) {
    const err = document.getElementById('w_error');
    if (err) {
      err.style.display='block';
      err.textContent = 'Page init failed: ' + (e?.message || e);
    } else {
      document.body.innerHTML = '<div style="max-width:960px;margin:2rem auto;padding:1rem;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;border-radius:8px;">Page init failed.</div>';
    }
    console.error(e);
  }
});
</script>
</body>
</html>
