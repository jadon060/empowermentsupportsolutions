<!-- ========== ESS ‚Ä¢ Weekly Charting (Hybrid Drafts: Server + Local) + Daily Service Entry (Live) ========== -->

<!-- ===== Weekly Chart (HYBRID DRAFTS) ===== -->
<section style="max-width:980px;margin:2rem auto;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06);font-family:sans-serif;border:1px solid #e5e7eb;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <h2 style="margin:0;">üìÖ Weekly Chart (Mon‚ÄìSun)</h2>
    <button id="w_submitWeek" disabled title="Enabled in Step 2b"
            style="padding:10px 14px;border-radius:10px;border:1px solid #2c3e50;background:#2c3e50;color:#fff;cursor:not-allowed;opacity:.6;">
      Submit Weekly Report
    </button>
  </div>
  <p style="margin:.25rem 0 1rem 0;color:#6b7280;">
    Click a day, enter notes/hours, and <strong>Save Day</strong>. Drafts save to <strong>Supabase + local</strong> for safety.
  </p>

  <!-- Week bar -->
  <div style="display:flex;align-items:center;gap:12px;border:1px solid #e5e7eb;padding:10px;border-radius:10px;background:#f8fafc;">
    <button id="w_prevWeek" aria-label="Previous week"
            style="width:36px;height:36px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;">‚óÄ</button>
    <div>
      <div id="w_range" style="font-weight:700;color:#0f172a;">Mon ‚Äî Sun</div>
      <div style="color:#6b7280;font-size:13px;">Week of <span id="w_startTxt"></span> to <span id="w_endTxt"></span></div>
    </div>
    <button id="w_nextWeek" aria-label="Next week"
            style="width:36px;height:36px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;">‚ñ∂</button>
    <div style="flex:1;"></div>
    <span style="font-size:12px;background:#eef2ff;border:1px solid #e5e7eb;padding:6px 10px;border-radius:999px;color:#0f172a;">
      Drafts: server + local
    </span>
  </div>

  <!-- Days grid -->
  <div id="w_days" style="display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:14px;"></div>

  <!-- Day panel -->
  <div id="w_panel" style="display:none;margin-top:12px;border-top:1px solid #e5e7eb;padding-top:12px;">
    <div id="w_panelDate" style="color:#6b7280;margin-bottom:10px;"></div>

    <div style="display:grid;gap:12px;grid-template-columns:1fr 1fr;">
      <div>
        <label for="w_hours" style="display:block;color:#6b7280;font-size:12px;margin-bottom:6px;">Hours Worked</label>
        <input id="w_hours" type="number" min="0" step="0.25" placeholder="e.g., 3.5"
               style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
      </div>
      <div>
        <label for="w_acts" style="display:block;color:#6b7280;font-size:12px;margin-bottom:6px;">Activities (quick summary)</label>
        <input id="w_acts" type="text" placeholder="Shopping, meal prep, budgeting‚Ä¶"
               style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
      </div>
    </div>

    <div style="margin-top:12px;">
      <label for="w_notes" style="display:block;color:#6b7280;font-size:12px;margin-bottom:6px;">Progress Notes</label>
      <textarea id="w_notes" placeholder="Objective notes about the session‚Ä¶"
                style="width:100%;min-height:120px;padding:10px;border:1px solid #e5e7eb;border-radius:10px;resize:vertical;"></textarea>
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px;">
      <button id="w_clearDay" style="padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;">Clear Day</button>
      <button id="w_saveDay"  style="padding:10px 14px;border-radius:10px;border:1px solid #2c3e50;background:#2c3e50;color:#fff;cursor:pointer;">Save Day</button>
    </div>

    <div style="font-size:12px;color:#6b7280;margin-top:8px;">Drafts load from <strong>server first</strong>, with local fallback.</div>
  </div>

  <!-- Local toast (created by script if missing) -->
  <div id="w_toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.2);z-index:1000;font-size:14px;opacity:0;transition:opacity .25s;"></div>
</section>

<!-- ===== Weekly Chart Script (SERVER-FIRST LOAD + UPSERT on SAVE) ===== -->
<script>
(() => {
  // ===== Read real IDs from existing form so drafts belong to the right client/staff =====
  const CLIENT_ID_INPUT = document.getElementById('client_id');
  const STAFF_SELECT    = document.getElementById('staff_id');
  const getClientId = () => (CLIENT_ID_INPUT?.value || 'CLIENT_UUID_OMAR');
  const getStaffId  = () => (STAFF_SELECT?.value || 'STAFF_UUID_PLACEHOLDER');

  // ===== Helpers =====
  const fmt = (d)=>new Intl.DateTimeFormat('en-US',{month:'short',day:'2-digit',year:'numeric'}).format(d);
  const ymd = (d)=>d.toISOString().slice(0,10);
  function startOfWeekMonday(d){
    const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
    const day = nd.getDay(); // 0=Sun
    const diff = (day===0 ? -6 : 1 - day);
    nd.setDate(nd.getDate()+diff);
    nd.setHours(0,0,0,0);
    return nd;
  }
  function addDays(d,n){ const nd=new Date(d); nd.setDate(nd.getDate()+n); return nd; }

  // Toast
  const w_toast = document.getElementById('w_toast') || (() => {
    const el=document.createElement('div'); el.id='w_toast';
    el.style.cssText='position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.2);z-index:1000;font-size:14px;opacity:0;transition:opacity .25s;';
    document.body.appendChild(el); return el;
  })();
  function toast(msg){ w_toast.textContent=msg; w_toast.style.opacity='1'; setTimeout(()=>w_toast.style.opacity='0',1400); }

  // DOM
  const w_days     = document.getElementById('w_days');
  const w_range    = document.getElementById('w_range');
  const w_startTxt = document.getElementById('w_startTxt');
  const w_endTxt   = document.getElementById('w_endTxt');
  const w_prevWeek = document.getElementById('w_prevWeek');
  const w_nextWeek = document.getElementById('w_nextWeek');
  const w_panel    = document.getElementById('w_panel');
  const w_panelDate= document.getElementById('w_panelDate');
  const w_hours    = document.getElementById('w_hours');
  const w_acts     = document.getElementById('w_acts');
  const w_notes    = document.getElementById('w_notes');
  const w_saveDay  = document.getElementById('w_saveDay');
  const w_clearDay = document.getElementById('w_clearDay');

  // State
  let current = startOfWeekMonday(new Date());
  let activeIndex = null;

  // Local cache keys
  const weekKey = (wk)=>`essWeek_${getClientId()}_${getStaffId()}_${ymd(wk)}`;
  const dayKey  = (wk,i)=>`${weekKey(wk)}_d${i}`; // 0..6

  // Supabase helpers (uses global `ess` that the page creates below)
  async function fetchDraftFromServer(i){
    try{
      if (typeof ess === 'undefined' || !getStaffId() || getStaffId()==='') return null;
      const { data, error } = await ess
        .from('daily_drafts')
        .select('hours, activities, notes')
        .eq('client_id', getClientId())
        .eq('staff_id',  getStaffId())
        .eq('week_start', ymd(current))
        .eq('day_index', i)
        .maybeSingle();
      if (error) return null;
      return data || null;
    }catch{ return null; }
  }

  async function upsertDraftToServer(i, payload){
    try{
      if (typeof ess === 'undefined' || !getStaffId() || getStaffId()==='') return;
      const body = {
        client_id:  getClientId(),
        staff_id:   getStaffId(),
        week_start: ymd(current),
        day_index:  i,
        date:       payload.date,
        hours:      payload.hours !== '' ? Number(payload.hours) : null,
        activities: payload.activities || null,
        notes:      payload.notes || null,
        submitted:  false
      };
      await ess
        .from('daily_drafts')
        .upsert(body, { onConflict: 'client_id,staff_id,week_start,day_index' });
    }catch(e){
      console.warn('Upsert draft failed (local cache still intact):', e);
    }
  }

  function markDots(){
    for(let i=0;i<7;i++){
      const dot = document.getElementById(`w_dot${i}`);
      const has = localStorage.getItem(dayKey(current,i));
      if(dot){ dot.style.background = has ? '#22c55e' : '#e5e7eb'; }
    }
  }

  function renderWeek(){
    const start = new Date(current);
    const end   = addDays(start,6);
    w_startTxt.textContent = fmt(start);
    w_endTxt.textContent   = fmt(end);
    w_range.textContent    = `Mon ${start.getDate()} ‚Äî Sun ${end.getDate()}`;

    const names = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    w_days.innerHTML = '';
    for(let i=0;i<7;i++){
      const d = addDays(start,i);
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.style.cssText = 'position:relative;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;cursor:pointer;width:100%;text-align:left;';
      btn.innerHTML = `
        <div style="font-size:12px;color:#6b7280;">${names[i]}</div>
        <div style="font-size:16px;font-weight:800;color:#0f172a;">${d.getDate()}</div>
        <div id="w_dot${i}" style="position:absolute;right:10px;top:10px;width:8px;height:8px;border-radius:999px;background:#e5e7eb;"></div>
      `;
      btn.addEventListener('click',()=>openDay(i));
      w_days.appendChild(btn);
    }
    markDots();

    // Auto-open today if within range
    const today = new Date();
    const inRange = +today>=+start && +today<=+end;
    openDay(inRange ? (today.getDay()===0?6:today.getDay()-1) : 0);
  }

  // Open Day: server-first, fallback to local
  async function openDay(i){
    activeIndex = i;
    [...w_days.children].forEach((el,idx)=>{
      el.style.outline = (idx===i) ? '2px solid #0ea5e9' : 'none';
    });
    const d = addDays(current,i);
    w_panelDate.textContent = `${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i]} ‚Äî ${fmt(d)}`;

    const fromServer = await fetchDraftFromServer(i);
    if (fromServer) {
      w_hours.value = (fromServer.hours ?? '') === null ? '' : fromServer.hours;
      w_acts.value  = fromServer.activities ?? '';
      w_notes.value = fromServer.notes ?? '';
    } else {
      const raw = localStorage.getItem(dayKey(current,i));
      if(raw){
        try{
          const obj = JSON.parse(raw);
          w_hours.value = obj.hours ?? '';
          w_acts.value  = obj.activities ?? '';
          w_notes.value = obj.notes ?? '';
        }catch{ w_hours.value = w_acts.value = w_notes.value = ''; }
      } else {
        w_hours.value = w_acts.value = w_notes.value = '';
      }
    }
    w_panel.style.display = 'block';
  }

  // Save Day: local + server UPSERT
  async function saveDay(){
    if(activeIndex==null) return;
    if(!getStaffId() || getStaffId()===''){ toast('Select Staff first to save ‚úì'); return; }

    const payload = {
      client_id:  getClientId(),
      staff_id:   getStaffId(),
      week_start: ymd(current),
      day_index:  activeIndex,
      date:       ymd(addDays(current,activeIndex)),
      hours:      (w_hours.value||''),
      activities: (w_acts.value||''),
      notes:      (w_notes.value||'')
    };

    // 1) Local cache
    localStorage.setItem(dayKey(current,activeIndex), JSON.stringify(payload));
    markDots();

    // 2) Server UPSERT
    await upsertDraftToServer(activeIndex, payload);

    toast('Day saved ‚úì');
  }

  function clearDay(){
    if(activeIndex==null) return;
    localStorage.removeItem(dayKey(current,activeIndex));
    w_hours.value = w_acts.value = w_notes.value = '';
    markDots();
    toast('Day cleared (local only). Server copy remains until weekly submit.');
  }

  function shiftWeek(delta){
    current = addDays(current, 7*delta);
    renderWeek();
  }

  w_prevWeek.addEventListener('click',()=>shiftWeek(-1));
  w_nextWeek.addEventListener('click',()=>shiftWeek(1));
  w_saveDay.addEventListener('click',()=>saveDay());
  w_clearDay.addEventListener('click',()=>clearDay());

  renderWeek();
})();
</script>

<!-- ===== Daily Service Entry (UNCHANGED, LIVE TO SUPABASE) ===== -->
<section style="max-width:720px;margin:2rem auto;padding:2rem;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06);font-family:sans-serif;">
  <h2 style="margin:0 0 8px 0;">üìù Daily Service Entry ‚Äî Omar A.</h2>
  <p style="margin:0 0 16px 0;color:#6b7280;">Week runs Mon ‚Üí Sun. EVV will be added later.</p>

  <!-- Status / alerts -->
  <div id="alert" style="display:none;margin-bottom:12px;padding:10px;border-radius:8px;"></div>

  <form id="dailyForm">
    <!-- Hidden client (prefilled) -->
    <input type="hidden" id="client_id" value="CLIENT_UUID_OMAR" />

    <!-- Staff (loaded from ess.staff) -->
    <label for="staff_id" style="font-weight:600;">Staff</label>
    <select id="staff_id" required style="width:100%;padding:10px;margin:6px 0 14px 0;border:1px solid #e5e7eb;border-radius:8px;">
      <option value="">Select staff‚Ä¶</option>
    </select>

    <!-- Date -->
    <label for="service_date" style="font-weight:600;">Date of Service</label>
    <input type="date" id="service_date" required
           style="width:100%;padding:10px;margin:6px 0 14px 0;border:1px solid #e5e7eb;border-radius:8px;">

    <!-- Times -->
    <div style="display:flex;gap:12px;margin-bottom:14px;">
      <div style="flex:1;">
        <label for="start_time" style="font-weight:600;">Start Time</label>
        <input type="time" id="start_time"
               style="width:100%;padding:10px;margin-top:6px;border:1px solid #e5e7eb;border-radius:8px;">
      </div>
      <div style="flex:1;">
        <label for="end_time" style="font-weight:600;">End Time</label>
        <input type="time" id="end_time"
               style="width:100%;padding:10px;margin-top:6px;border:1px solid #e5e7eb;border-radius:8px;">
      </div>
    </div>

    <!-- Modality (must match DB: Home | Community | Remote) -->
    <label for="modality" style="font-weight:600;">Modality / Location</label>
    <select id="modality" required
            style="width:100%;padding:10px;margin:6px 0 14px 0;border:1px solid #e5e7eb;border-radius:8px;">
      <option value="Home">Home</option>
      <option value="Community">Community</option>
      <option value="Remote" selected>Remote</option>
    </select>

    <!-- Activities (free text for now) -->
    <label for="activities" style="font-weight:600;">Activities (quick summary)</label>
    <textarea id="activities" placeholder="e.g., Personal: morning routine; Technology: tablet practice"
              style="width:100%;min-height:84px;padding:10px;margin:6px 0 14px 0;border:1px solid #e5e7eb;border-radius:8px;"></textarea>

    <!-- Narrative notes -->
    <label for="service_notes" style="font-weight:600;">Service Notes (narrative)</label>
    <textarea id="service_notes" placeholder="what/where/with whom, goals, outcomes, behaviors/resources"
              style="width:100%;min-height:120px;padding:10px;margin:6px 0 16px 0;border:1px solid #e5e7eb;border-radius:8px;"></textarea>

    <button type="submit"
            style="padding:12px 16px;border-radius:10px;border:1px solid #111827;background:#111827;color:#fff;cursor:pointer;">
      Save Daily Entry
    </button>
  </form>

  <!-- Debug output (optional) -->
  <pre id="debug" style="margin-top:1rem;background:#f9fafb;padding:12px;border-radius:8px;white-space:pre-wrap;"></pre>
</section>

<!-- Supabase client (for daily form AND weekly drafts server write) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // -------- CONFIG (UNCHANGED) --------
  const SUPABASE_URL = "https://bqanjupmcgydvmfgvutx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYW5qdXBtY2d5ZHZtZmd2dXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTI4NzQsImV4cCI6MjA3NjM4ODg3NH0.J3A12rwUlSqjIsmlnNCcwis6Qt_ryw7ZzFqLftuMKUk";
  const CLIENT_ID = document.getElementById("client_id").value; // Omar's UUID

  // Init client + schema
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const ess = sb.schema("ess");

  const $ = (id) => document.getElementById(id);
  const alertBox = $("alert");
  const debug = $("debug");

  // Simple alert helpers
  function showOk(msg) {
    alertBox.style.display = "block";
    alertBox.style.background = "#ecfdf5";
    alertBox.style.border = "1px solid #34d399";
    alertBox.textContent = "‚úÖ " + msg;
  }
  function showErr(msg) {
    alertBox.style.display = "block";
    alertBox.style.background = "#fef2f2";
    alertBox.style.border = "1px solid #fca5a5";
    alertBox.textContent = "‚ùå " + msg;
  }
  function clearAlert() {
    alertBox.style.display = "none";
    alertBox.textContent = "";
  }

  // -------- INIT: load staff list (UNCHANGED) --------
  (async function loadStaff() {
    const sel = $("staff_id");
    sel.disabled = true;

    const { data, error } = await ess
      .from("staff")
      .select("id, full_name")
      .order("full_name", { ascending: true });

    if (error) {
      showErr(error.message);
      return;
    }
    (data || []).forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.full_name;
      sel.appendChild(opt);
    });
    sel.disabled = false;
  })();

  // -------- SUBMIT HANDLER (UNCHANGED) --------
  $("dailyForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    clearAlert();
    debug.textContent = "‚è≥ Saving‚Ä¶";

    const entry = {
      client_id: CLIENT_ID,
      staff_id: $("staff_id").value,
      service_date: $("service_date").value,                 // date (YYYY-MM-DD)
      start_time: $("start_time").value || null,             // time or null
      end_time: $("end_time").value || null,                 // time or null
      modality: $("modality").value,                         // Home | Community | Remote
      activities: [($("activities").value || "").trim()],    // simple array for now
      service_notes: ($("service_notes").value || "").trim() || null
    };

    // Basic required checks
    if (!entry.staff_id)  { showErr("Please select a Staff."); return; }
    if (!entry.service_date) { showErr("Please select a Date of Service."); return; }

    const { data, error } = await ess.from("daily_entries").insert(entry).select();
    if (error) {
      debug.textContent = "";
      showErr(error.message);
      return;
    }

    // Success
    showOk("Saved! Your daily entry has been recorded.");
    debug.textContent = JSON.stringify(data, null, 2);

    // Optional: clear most fields for the next entry
    $("start_time").value = "";
    $("end_time").value = "";
    $("activities").value = "";
    $("service_notes").value = "";
  });
</script>
