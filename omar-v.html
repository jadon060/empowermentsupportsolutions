<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ESS â€¢ Weekly Chart (Monâ€“Sun)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* optional: smooth font & base reset */
    html,body{margin:0;padding:0;background:#f7f7fb;color:#0f172a}
    /* NEW: prevent overflow from padding/borders */
    *,*::before,*::after{box-sizing:border-box}

    /* Fix overlapping on narrow screens */
    .row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
    .row > *{min-width:240px;flex:1}
    .weekbar{display:flex;align-items:center;gap:12px;border:1px solid #e5e7eb;padding:10px;border-radius:10px;background:#f8fafc;flex-wrap:wrap}
    .weekbar > *{flex:0 0 auto}
    .weekbar .spacer{flex:1 1 auto;min-width:60px}

    /* Buttons */
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn--primary{border-color:#2c3e50;background:#2c3e50;color:#fff}
    .btn--dark{border-color:#1f2937;background:#1f2937;color:#fff}
    .btn--icon{width:36px;height:36px}

    /* Day buttons */
    .daybtn{position:relative;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;cursor:pointer;width:100%;text-align:left}
    .dot{position:absolute;right:10px;top:10px;width:8px;height:8px;border-radius:999px;background:#e5e7eb}

    /* Inputs */
    .input, .select, .textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    .textarea{min-height:120px;resize:vertical}

    /* Labels */
    .label{display:block;color:#6b7280;font-size:12px;margin-bottom:6px}

    /* Pills */
    .pill{font-size:12px;background:#eef2ff;border:1px solid #e5e7eb;padding:6px 10px;border-radius:999px;color:#0f172a}

    /* Toast + error */
    #w_toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.2);z-index:1000;font-size:14px;opacity:0;transition:opacity .25s}
    #w_error{display:none;margin-top:12px;padding:10px;border-radius:8px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b}
  </style>
</head>
<body>

<!-- ========== ESS â€¢ Single Weekly Chart (Drafts + Official Submissions) ========== -->
<section style="max-width:980px;margin:2rem auto;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06);font-family:sans-serif;border:1px solid #e5e7eb;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px;">
    <h2 style="margin:0;">ðŸ“… Weekly Chart (Monâ€“Sun)</h2>
    <button id="w_submitWeek" disabled title="Weekly submit will be enabled next"
            class="btn btn--primary" style="opacity:.6;cursor:not-allowed;">
      Submit Weekly Report
    </button>
  </div>

  <!-- Staff + Client -->
  <div class="row" style="margin-bottom:10px;">
    <!-- REAL Omar UUID to prevent uuid errors -->
    <input type="hidden" id="client_id" value="521dd725-2fa6-4d78-9fcc-e5447dc727cb" />
    <div>
      <label for="staff_id" class="label">Staff (type your name)</label>
      <!-- switched from <select> to free-text input -->
      <input id="staff_id" type="text" class="input" placeholder="e.g., Jane Smith" required />
    </div>
    <span class="pill">Drafts: server + local</span>
  </div>

  <!-- Week bar -->
  <div class="weekbar">
    <button id="w_prevWeek" aria-label="Previous week" class="btn btn--icon">â—€</button>
    <div>
      <div id="w_range" style="font-weight:700;color:#0f172a;">Mon â€” Sun</div>
      <div style="color:#6b7280;font-size:13px;">Week of <span id="w_startTxt"></span> to <span id="w_endTxt"></span></div>
    </div>
    <button id="w_nextWeek" aria-label="Next week" class="btn btn--icon">â–¶</button>
    <div class="spacer"></div>
  </div>

  <!-- Days grid -->
  <div id="w_days" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-top:14px;"></div>

  <!-- Day panel -->
  <div id="w_panel" style="display:none;margin-top:12px;border-top:1px solid #e5e7eb;padding-top:12px;">
    <div id="w_panelDate" style="color:#6b7280;margin-bottom:10px;"></div>

    <!-- Times + Modality -->
    <div class="row">
      <div>
        <label for="w_start" class="label">Start Time</label>
        <input id="w_start" type="time" class="input">
      </div>
      <div>
        <label for="w_end" class="label">End Time</label>
        <input id="w_end" type="time" class="input">
      </div>
      <div>
        <label for="w_modality" class="label">Modality / Location</label>
        <select id="w_modality" class="select">
          <option value="Home">Home</option>
          <option value="Community">Community</option>
          <option value="Remote" selected>Remote</option>
        </select>
      </div>
    </div>

    <!-- Hours + Domain -->
    <div class="row" style="margin-top:12px;">
      <div>
        <label for="w_hours" class="label">Hours Worked</label>
        <input id="w_hours" type="number" min="0" step="0.25" placeholder="e.g., 3.5" class="input">
      </div>
      <div>
        <label for="w_domain" class="label">Domain (service codes worked on)</label>
        <input id="w_domain" type="text" placeholder="e.g., Money Mgmt, Hygiene, Safetyâ€¦" class="input">
      </div>
    </div>

    <!-- Progress Notes -->
    <div style="margin-top:12px;">
      <label for="w_notes" class="label">Progress Notes</label>
      <textarea id="w_notes" class="textarea" placeholder="what/where/with whom, goals"></textarea>
    </div>

    <!-- Observation -->
    <div style="margin-top:12px;">
      <label for="w_obs" class="label">Observation</label>
      <textarea id="w_obs" class="textarea" placeholder="reaction/response to today's services"></textarea>
    </div>

    <!-- Action Plan -->
    <div style="margin-top:12px;">
      <label for="w_plan" class="label">Action Plan</label>
      <textarea id="w_plan" class="textarea" placeholder="next steps to work on the service codes"></textarea>
    </div>

    <!-- Actions -->
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
      <button id="w_clearDay" class="btn">Clear Day</button>
      <button id="w_saveDay"  class="btn btn--dark">Save Day (Draft)</button>
      <button id="w_submitDay" class="btn btn--primary">Submit Day (Official)</button>
    </div>

    <!-- (removed the helper sentence per your request) -->
  </div>

  <!-- Error banner (hidden by default) -->
  <div id="w_error"></div>

  <!-- Toast -->
  <div id="w_toast"></div>
</section>

<!-- Supabase client -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ===== Supabase boot ===== */
  const SUPABASE_URL = "https://bqanjupmcgydvmfgvutx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYW5qdXBtY2d5ZHZtZmd2dXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTI4NzQsImV4cCI6MjA3NjM4ODg3NH0.J3A12rwUlSqjIsmlnNCcwis6Qt_ryw7ZzFqLftuMKUk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const ess = sb.schema("ess");

  /* ===== DOM shortcuts ===== */
  const $ = (id)=>document.getElementById(id);
  const CLIENT_ID_INPUT = $("client_id");
  const STAFF_INPUT     = $("staff_id");

  const w_days=$("w_days"), w_range=$("w_range"), w_startTxt=$("w_startTxt"), w_endTxt=$("w_endTxt");
  const w_prevWeek=$("w_prevWeek"), w_nextWeek=$("w_nextWeek");
  const w_panel=$("w_panel"), w_panelDate=$("w_panelDate");
  const w_start=$("w_start"), w_end=$("w_end"), w_modality=$("w_modality");
  const w_hours=$("w_hours"), w_domain=$("w_domain"), w_notes=$("w_notes");
  const w_obs=$("w_obs"), w_plan=$("w_plan");
  const w_saveDay=$("w_saveDay"), w_clearDay=$("w_clearDay"), w_submitDay=$("w_submitDay");
  const w_toast=$("w_toast"), w_error=$("w_error");

  const REQUIRED = ["client_id","staff_id","w_days","w_range","w_startTxt","w_endTxt","w_prevWeek","w_nextWeek","w_panel","w_panelDate","w_start","w_end","w_modality","w_hours","w_domain","w_notes","w_obs","w_plan","w_saveDay","w_clearDay","w_submitDay","w_toast","w_error"];
  const missing = REQUIRED.filter(id => !$(id));
  if (missing.length) {
    w_error.style.display='block';
    w_error.innerHTML = "Setup error â€” missing element IDs: " + missing.map(m=>`<code>${m}</code>`).join(", ");
    return;
  }

  /* ===== Utils ===== */
  function toast(m){w_toast.textContent=m;w_toast.style.opacity='1';setTimeout(()=>w_toast.style.opacity='0',1400);}
  const fmt = (d)=>new Intl.DateTimeFormat('en-US',{month:'short',day:'2-digit',year:'numeric'}).format(d);
  const ymd = (d)=>d.toISOString().slice(0,10);
  function startOfWeekMonday(d){const nd=new Date(d.getFullYear(),d.getMonth(),d.getDate());const day=nd.getDay();const diff=(day===0?-6:1-day);nd.setDate(nd.getDate()+diff);nd.setHours(0,0,0,0);return nd;}
  function addDays(d,n){const nd=new Date(d);nd.setDate(nd.getDate()+n);return nd;}

  const getClientId=()=>CLIENT_ID_INPUT.value;
  const getStaffId =()=> (STAFF_INPUT.value || "").trim(); // now free-text

  let current = startOfWeekMonday(new Date());
  let activeIndex = null;

  /* ===== Local cache keys ===== */
  const weekKey = (wk)=>`essWeek_${getClientId()}_${getStaffId()}_${ymd(wk)}`;
  const dayKey  = (wk,i)=>`${weekKey(wk)}_d${i}`;

  /* ===== Server helpers =====
     For compatibility, we continue to use:
     - daily_drafts: hours, activities, notes, date, submitted, start_time, end_time, modality
     - daily_entries: activities, service_notes (+ other base fields)
     We only RELABEL "activities" -> "domain" in UI.
     Observation + Action Plan are merged into notes on save/submit so schema remains unchanged. */
  async function fetchDraft(i){
    try{
      if(!getStaffId()) return null;
      const { data, error } = await ess.from("daily_drafts")
        .select("hours, activities, notes, date, submitted, start_time, end_time, modality")
        .eq("client_id", getClientId()).eq("staff_id", getStaffId())
        .eq("week_start", ymd(current)).eq("day_index", i).maybeSingle();
      if(error) return null; return data||null;
    }catch{ return null; }
  }

  async function upsertDraft(i, payload){
    try{
      if(!getStaffId()) return;
      const body = {
        client_id:getClientId(), staff_id:getStaffId(),
        week_start: ymd(current), day_index: i, date: payload.date,
        hours: payload.hours!==''? Number(payload.hours):null,
        activities: payload.activities||null, // store the typed domain here
        notes: payload.notes || null,         // merged notes including Observation + Plan
        start_time: payload.start_time||null, end_time: payload.end_time||null,
        modality: payload.modality||'Remote', submitted: false
      };
      await ess.from("daily_drafts").upsert(body, { onConflict: "client_id,staff_id,week_start,day_index" });
    }catch(e){ console.warn("Upsert draft failed:", e); }
  }

  // Insert official record while keeping activities compatibility
  async function insertDailyEntry(payload){
    const raw = (payload.activities||"").trim();
    const acts = raw ? [raw] : null; // single-item array if your column is text[] with a constraint

    const entryBase = {
      client_id: getClientId(),
      staff_id:  getStaffId(),
      service_date: payload.date,
      start_time: payload.start_time || null,
      end_time:   payload.end_time   || null,
      modality:   payload.modality   || 'Remote',
      service_notes: payload.notes || null
    };

    // 1) Try with activities (if provided)
    let { error } = await ess.from("daily_entries").insert({ ...entryBase, activities: acts });
    if (error && String(error.message||'').includes('activities_allowed')) {
      // 2) Fallback: submit with activities = null (in case of constraint mismatch)
      ({ error } = await ess.from("daily_entries").insert({ ...entryBase, activities: null }));
    }
    if (error) throw error;
  }

  /* ===== UI ===== */
  function markDots(){
    for(let i=0;i<7;i++){
      const dot = document.getElementById(`w_dot${i}`);
      const has = localStorage.getItem(dayKey(current,i));
      if(dot){ dot.style.background = has ? '#22c55e' : '#e5e7eb'; }
    }
  }

  function renderWeek(){
    const start=new Date(current), end=addDays(start,6);
    w_startTxt.textContent=fmt(start); w_endTxt.textContent=fmt(end);
    w_range.textContent=`Mon ${start.getDate()} â€” Sun ${end.getDate()}`;

    const names=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    w_days.innerHTML='';
    for(let i=0;i<7;i++){
      const d = addDays(start,i);
      const btn = document.createElement('button');
      btn.type='button';
      btn.className='daybtn';
      btn.innerHTML=`
        <div style="font-size:12px;color:#6b7280;">${names[i]}</div>
        <div style="font-size:16px;font-weight:800;color:#0f172a;">${d.getDate()}</div>
        <div id="w_dot${i}" class="dot"></div>
      `;
      btn.addEventListener('click',()=>openDay(i));
      w_days.appendChild(btn);
    }
    markDots();
    const today=new Date(); const inRange=+today>=+start && +today<=+end;
    openDay(inRange ? (today.getDay()===0?6:today.getDay()-1) : 0);
  }

  function parseMergedNotes(text){
    // Split back into the three parts if previously merged; very forgiving
    const out = { notes:'', obs:'', plan:'' };
    if(!text) return out;
    const N='## Progress Notes:', O='## Observation:', P='## Action Plan:';
    if(text.includes(N)){
      const nIdx=text.indexOf(N)+N.length;
      const oIdx=text.indexOf(O, nIdx);
      const pIdx=text.indexOf(P, oIdx>-1?oIdx:nIdx);
      out.notes = text.slice(nIdx, oIdx>-1?oIdx: (pIdx>-1?pIdx:text.length)).trim();
      if(oIdx>-1){
        out.obs = text.slice(oIdx+O.length, pIdx>-1?pIdx:text.length).trim();
      }
      if(pIdx>-1){
        out.plan = text.slice(pIdx+P.length).trim();
      }
      return out;
    }
    // legacy plain notes
    out.notes = text;
    return out;
  }

  function mergeNotes(notes, obs, plan){
    const parts = [];
    parts.push("## Progress Notes:\n" + (notes||"").trim());
    parts.push("## Observation:\n" + (obs||"").trim());
    parts.push("## Action Plan:\n" + (plan||"").trim());
    return parts.join("\n\n").trim();
  }

  async function openDay(i){
    activeIndex=i; w_error.style.display='none'; w_error.textContent='';
    [...w_days.children].forEach((el,idx)=>{ el.style.outline=(idx===i)?'2px solid #0ea5e9':'none'; });
    const d=addDays(current,i);
    w_panelDate.textContent=`${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i]} â€” ${fmt(d)}`;

    const srv=await fetchDraft(i);
    if(srv){
      w_hours.value = srv.hours ?? '';
      w_domain.value= srv.activities ?? ''; // domain label, still stored in activities
      const parsed = parseMergedNotes(srv.notes ?? '');
      w_notes.value = parsed.notes ?? '';
      w_obs.value   = parsed.obs ?? '';
      w_plan.value  = parsed.plan ?? '';
      w_start.value = srv.start_time ?? '';
      w_end.value   = srv.end_time ?? '';
      w_modality.value = srv.modality ?? 'Remote';
    }else{
      const raw=localStorage.getItem(dayKey(current,i));
      if(raw){
        try{
          const obj=JSON.parse(raw);
          w_hours.value = obj.hours ?? '';
          w_domain.value= obj.domain ?? (obj.activities ?? '');
          w_notes.value = obj.notes_only ?? obj.notes ?? '';
          w_obs.value   = obj.observation ?? '';
          w_plan.value  = obj.action_plan ?? '';
          w_start.value = obj.start_time ?? '';
          w_end.value   = obj.end_time ?? '';
          w_modality.value = obj.modality ?? 'Remote';
        }catch{
          w_hours.value=w_domain.value=w_notes.value=w_obs.value=w_plan.value=w_start.value=w_end.value='';
          w_modality.value='Remote';
        }
      }else{
        w_hours.value=w_domain.value=w_notes.value=w_obs.value=w_plan.value=w_start.value=w_end.value='';
        w_modality.value='Remote';
      }
    }
    w_panel.style.display='block';
  }

  /* ===== Actions ===== */
  function buildPayload(){
    const notesMerged = mergeNotes(
      (w_notes.value||''),
      (w_obs.value||''),
      (w_plan.value||'')
    );
    return {
      date: ymd(addDays(current,activeIndex)),
      hours: (w_hours.value||''),
      activities: (w_domain.value||''), // UI "Domain" mapped to activities field for DB compatibility
      notes: notesMerged,
      notes_only: (w_notes.value||''), // keep for local convenience
      observation: (w_obs.value||''),
      action_plan: (w_plan.value||''),
      start_time: (w_start.value||''),
      end_time: (w_end.value||''),
      modality: (w_modality.value||'Remote')
    };
  }

  async function saveDay(){
    if(activeIndex==null) return;
    if(!getStaffId()){ toast('Type Staff name first'); return; }
    const payload = buildPayload();

    // local cache (keep domain + split sections too)
    localStorage.setItem(dayKey(current,activeIndex), JSON.stringify({
      ...payload,
      domain: payload.activities // alias for clarity in local storage
    }));
    markDots();

    // server draft
    await upsertDraft(activeIndex, payload);
    toast('Day saved (draft) âœ“');
  }

  function clearDay(){
    if(activeIndex==null) return;
    localStorage.removeItem(dayKey(current,activeIndex));
    w_hours.value=w_domain.value=w_notes.value=w_obs.value=w_plan.value=w_start.value=w_end.value='';
    w_modality.value='Remote';
    markDots();
    toast('Day cleared locally. Server draft remains until overwritten.');
  }

  async function submitDay(){
    if(activeIndex==null) return;
    if(!getStaffId()){ toast('Type Staff name first'); return; }
    const payload = buildPayload();

    try{
      await insertDailyEntry(payload);      // official record
      await upsertDraft(activeIndex, payload);
      // persist locally
      localStorage.setItem(dayKey(current,activeIndex), JSON.stringify({
        ...payload,
        domain: payload.activities
      }));
      markDots();
      toast('Day submitted (official) âœ…');
    }catch(e){
      console.error('Submit error:', e);
      w_error.style.display='block';
      w_error.textContent = 'Submit failed: ' + (e?.message || 'Unknown error');
      toast('Submit failed âŒ');
    }
  }

  function shiftWeek(delta){ current=addDays(current,7*delta); renderWeek(); }

  /* ===== Bind ===== */
  w_prevWeek.addEventListener('click',()=>shiftWeek(-1));
  w_nextWeek.addEventListener('click',()=>shiftWeek(1));
  w_saveDay.addEventListener('click',saveDay);
  w_clearDay.addEventListener('click',clearDay);
  w_submitDay.addEventListener('click',submitDay);

  /* ===== Start ===== */
  renderWeek();
});
</script>
</body>
</html>
