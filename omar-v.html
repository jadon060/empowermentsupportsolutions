<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  /* ===== Supabase boot ===== */
  const SUPABASE_URL = "https://bqanjupmcgydvmfgvutx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYW5qdXBtY2d5ZHZtZmd2dXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTI4NzQsImV4cCI6MjA3NjM4ODg3NH0.J3A12rwUlSqjIsmlnNCcwis6Qt_ryw7ZzFqLftuMKUk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const ess = sb.schema("ess");

  /* ===== DOM shortcuts ===== */
  const $ = (id)=>document.getElementById(id);
  const CLIENT_ID_INPUT = $("client_id");
  const STAFF_INPUT     = $("staff_id");

  const w_days=$("w_days"), w_range=$("w_range"), w_startTxt=$("w_startTxt"), w_endTxt=$("w_endTxt");
  const w_prevWeek=$("w_prevWeek"), w_nextWeek=$("w_nextWeek");
  const w_panel=$("w_panel"), w_panelDate=$("w_panelDate");
  const w_start=$("w_start"), w_end=$("w_end"), w_modality=$("w_modality");
  const w_hours=$("w_hours"), w_domain=$("w_domain"), w_notes=$("w_notes");
  const w_obs=$("w_obs"), w_plan=$("w_plan");
  const w_saveDay=$("w_saveDay"), w_clearDay=$("w_clearDay"), w_submitDay=$("w_submitDay");
  const w_toast=$("w_toast"), w_error=$("w_error");

  const REQUIRED = ["client_id","staff_id","w_days","w_range","w_startTxt","w_endTxt","w_prevWeek","w_nextWeek","w_panel","w_panelDate","w_start","w_end","w_modality","w_hours","w_domain","w_notes","w_obs","w_plan","w_saveDay","w_clearDay","w_submitDay","w_toast","w_error"];
  const missing = REQUIRED.filter(id => !$(id));
  if (missing.length) {
    w_error.style.display='block';
    w_error.innerHTML = "Setup error — missing element IDs: " + missing.map(m=>`<code>${m}</code>`).join(", ");
    return;
  }

  /* ===== Utils ===== */
  function toast(m){w_toast.textContent=m;w_toast.style.opacity='1';setTimeout(()=>w_toast.style.opacity='0',1400);}
  const fmt = (d)=>new Intl.DateTimeFormat('en-US',{month:'short',day:'2-digit',year:'numeric'}).format(d);
  const ymd = (d)=>d.toISOString().slice(0,10);
  function startOfWeekMonday(d){const nd=new Date(d.getFullYear(),d.getMonth(),d.getDate());const day=nd.getDay();const diff=(day===0?-6:1-day);nd.setDate(nd.getDate()+diff);nd.setHours(0,0,0,0);return nd;}
  function addDays(d,n){const nd=new Date(d);nd.setDate(nd.getDate()+n);return nd;}

  const getClientId = ()=> CLIENT_ID_INPUT.value;
  const getStaffName = ()=> (STAFF_INPUT.value || "").trim();

  // UUID helper + resolver (keeps your free-text UX, satisfies DB uuid)
  const isUuid = (s)=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);
  async function getStaffUuid() {
    const nameOrId = getStaffName();
    if (!nameOrId) return null;
    if (isUuid(nameOrId)) return nameOrId; // user pasted uuid
    // exact match first
    let { data, error } = await ess.from("staff").select("id, full_name").eq("full_name", nameOrId).maybeSingle();
    if (data?.id) return data.id;
    // fallback: case-insensitive contains
    ({ data, error } = await ess.from("staff").select("id, full_name").ilike("full_name", `%${nameOrId}%`).limit(1).maybeSingle());
    if (data?.id) return data.id;
    throw new Error(`Staff name not found in roster: "${nameOrId}".`);
  }

  let current = startOfWeekMonday(new Date());
  let activeIndex = null;

  /* ===== Local cache keys ===== */
  const weekKey = (wk)=>`essWeek_${getClientId()}_${getStaffName()}_${ymd(wk)}`;
  const dayKey  = (wk,i)=>`${weekKey(wk)}_d${i}`;

  /* ===== Server helpers =====
     We keep using the same schema. "Domain" stays mapped to activities.
     Observation + Action Plan are merged into notes for DB. */
  async function fetchDraft(i){
    try{
      const staffUuid = await getStaffUuid();
      if(!staffUuid) return null;
      const { data, error } = await ess.from("daily_drafts")
        .select("hours, activities, notes, date, submitted, start_time, end_time, modality")
        .eq("client_id", getClientId()).eq("staff_id", staffUuid)
        .eq("week_start", ymd(current)).eq("day_index", i).maybeSingle();
      if(error) return null; return data||null;
    }catch{ return null; }
  }

  async function upsertDraft(i, payload){
    try{
      const staffUuid = await getStaffUuid();
      if(!staffUuid) { toast('Type a valid Staff name'); return; }
      const body = {
        client_id:getClientId(), staff_id:staffUuid,
        week_start: ymd(current), day_index: i, date: payload.date,
        hours: payload.hours!==''? Number(payload.hours):null,
        activities: payload.activities||null,
        notes: payload.notes || null,
        start_time: payload.start_time||null, end_time: payload.end_time||null,
        modality: payload.modality||'Remote', submitted: false
      };
      await ess.from("daily_drafts").upsert(body, { onConflict: "client_id,staff_id,week_start,day_index" });
    }catch(e){ console.warn("Upsert draft failed:", e); }
  }

  // Insert official record while keeping activities compatibility
  async function insertDailyEntry(payload){
    const staffUuid = await getStaffUuid();
    if(!staffUuid) throw new Error('Type a valid Staff name');
    const raw = (payload.activities||"").trim();
    const acts = raw ? [raw] : null; // text[] compatibility

    const entryBase = {
      client_id: getClientId(),
      staff_id:  staffUuid,
      service_date: payload.date,
      start_time: payload.start_time || null,
      end_time:   payload.end_time   || null,
      modality:   payload.modality   || 'Remote',
      service_notes: payload.notes || null
    };

    let { error } = await ess.from("daily_entries").insert({ ...entryBase, activities: acts });
    if (error && String(error.message||'').includes('activities_allowed')) {
      ({ error } = await ess.from("daily_entries").insert({ ...entryBase, activities: null }));
    }
    if (error) throw error;
  }

  /* ===== UI ===== */
  function markDots(){
    for(let i=0;i<7;i++){
      const dot = document.getElementById(`w_dot${i}`);
      const has = localStorage.getItem(dayKey(current,i));
      if(dot){ dot.style.background = has ? '#22c55e' : '#e5e7eb'; }
    }
  }

  function renderWeek(){
    const start=new Date(current), end=addDays(start,6);
    w_startTxt.textContent=fmt(start); w_endTxt.textContent=fmt(end);
    w_range.textContent=`Mon ${start.getDate()} — Sun ${end.getDate()}`;

    const names=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    w_days.innerHTML='';
    for(let i=0;i<7;i++){
      const d = addDays(start,i);
      const btn = document.createElement('button');
      btn.type='button';
      btn.className='daybtn';
      btn.innerHTML=`
        <div style="font-size:12px;color:#6b7280;">${names[i]}</div>
        <div style="font-size:16px;font-weight:800;color:#0f172a;">${d.getDate()}</div>
        <div id="w_dot${i}" class="dot"></div>
      `;
      btn.addEventListener('click',()=>openDay(i));
      w_days.appendChild(btn);
    }
    markDots();
    const today=new Date(); const inRange=+today>=+start && +today<=+end;
    openDay(inRange ? (today.getDay()===0?6:today.getDay()-1) : 0);
  }

  function parseMergedNotes(text){
    const out = { notes:'', obs:'', plan:'' };
    if(!text) return out;
    const N='## Progress Notes:', O='## Observation:', P='## Action Plan:';
    if(text.includes(N)){
      const nIdx=text.indexOf(N)+N.length;
      const oIdx=text.indexOf(O, nIdx);
      const pIdx=text.indexOf(P, oIdx>-1?oIdx:nIdx);
      out.notes = text.slice(nIdx, oIdx>-1?oIdx: (pIdx>-1?pIdx:text.length)).trim();
      if(oIdx>-1){ out.obs = text.slice(oIdx+O.length, pIdx>-1?pIdx:text.length).trim(); }
      if(pIdx>-1){ out.plan = text.slice(pIdx+P.length).trim(); }
      return out;
    }
    out.notes = text; return out;
  }

  function mergeNotes(notes, obs, plan){
    const parts = [];
    parts.push("## Progress Notes:\n" + (notes||"").trim());
    parts.push("## Observation:\n" + (obs||"").trim());
    parts.push("## Action Plan:\n" + (plan||"").trim());
    return parts.join("\n\n").trim();
  }

  async function openDay(i){
    activeIndex=i; w_error.style.display='none'; w_error.textContent='';
    [...w_days.children].forEach((el,idx)=>{ el.style.outline=(idx===i)?'2px solid #0ea5e9':'none'; });
    const d=addDays(current,i);
    w_panelDate.textContent=`${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i]} — ${fmt(d)}`;

    const srv=await fetchDraft(i);
    if(srv){
      w_hours.value = srv.hours ?? '';
      w_domain.value= srv.activities ?? '';
      const parsed = parseMergedNotes(srv.notes ?? '');
      w_notes.value = parsed.notes ?? '';
      w_obs.value   = parsed.obs ?? '';
      w_plan.value  = parsed.plan ?? '';
      w_start.value = srv.start_time ?? '';
      w_end.value   = srv.end_time ?? '';
      w_modality.value = srv.modality ?? 'Remote';
    }else{
      const raw=localStorage.getItem(dayKey(current,i));
      if(raw){
        try{
          const obj=JSON.parse(raw);
          w_hours.value = obj.hours ?? '';
          w_domain.value= obj.domain ?? (obj.activities ?? '');
          w_notes.value = obj.notes_only ?? obj.notes ?? '';
          w_obs.value   = obj.observation ?? '';
          w_plan.value  = obj.action_plan ?? '';
          w_start.value = obj.start_time ?? '';
          w_end.value   = obj.end_time ?? '';
          w_modality.value = obj.modality ?? 'Remote';
        }catch{
          w_hours.value=w_domain.value=w_notes.value=w_obs.value=w_plan.value=w_start.value=w_end.value='';
          w_modality.value='Remote';
        }
      }else{
        w_hours.value=w_domain.value=w_notes.value=w_obs.value=w_plan.value=w_start.value=w_end.value='';
        w_modality.value='Remote';
      }
    }
    w_panel.style.display='block';
  }

  /* ===== Actions ===== */
  function buildPayload(){
    const notesMerged = mergeNotes((w_notes.value||''),(w_obs.value||''),(w_plan.value||''));
    return {
      date: ymd(addDays(current,activeIndex)),
      hours: (w_hours.value||''),
      activities: (w_domain.value||''),
      notes: notesMerged,
      notes_only: (w_notes.value||''),
      observation: (w_obs.value||''),
      action_plan: (w_plan.value||''),
      start_time: (w_start.value||''),
      end_time: (w_end.value||''),
      modality: (w_modality.value||'Remote')
    };
  }

  async function saveDay(){
    if(activeIndex==null) return;
    if(!getStaffName()){ toast('Type Staff name first'); return; }
    try{
      // ensure the name can resolve to a uuid before saving server-side
      await getStaffUuid();
    }catch(e){
      w_error.style.display='block';
      w_error.textContent = e.message || 'Unknown staff error';
      toast('Staff not found ❌');
      return;
    }

    const payload = buildPayload();

    // local cache
    localStorage.setItem(dayKey(current,activeIndex), JSON.stringify({
      ...payload,
      domain: payload.activities
    }));
    markDots();

    // server draft
    await upsertDraft(activeIndex, payload);
    toast('Day saved (draft) ✓');
  }

  function clearDay(){
    if(activeIndex==null) return;
    localStorage.removeItem(dayKey(current,activeIndex));
    w_hours.value=w_domain.value=w_notes.value=w_obs.value=w_plan.value=w_start.value=w_end.value='';
    w_modality.value='Remote';
    markDots();
    toast('Day cleared locally. Server draft remains until overwritten.');
  }

  async function submitDay(){
    if(activeIndex==null) return;
    if(!getStaffName()){ toast('Type Staff name first'); return; }
    const payload = buildPayload();

    try{
      await insertDailyEntry(payload);      // official record
      await upsertDraft(activeIndex, payload);
      localStorage.setItem(dayKey(current,activeIndex), JSON.stringify({
        ...payload,
        domain: payload.activities
      }));
      markDots();
      toast('Day submitted (official) ✅');
    }catch(e){
      console.error('Submit error:', e);
      w_error.style.display='block';
      w_error.textContent = 'Submit failed: ' + (e?.message || 'Unknown error');
      toast('Submit failed ❌');
    }
  }

  function shiftWeek(delta){ current=addDays(current,7*delta); renderWeek(); }

  /* ===== Bind ===== */
  w_prevWeek.addEventListener('click',()=>shiftWeek(-1));
  w_nextWeek.addEventListener('click',()=>shiftWeek(1));
  w_saveDay.addEventListener('click',saveDay);
  w_clearDay.addEventListener('click',clearDay);
  w_submitDay.addEventListener('click',submitDay);

  /* ===== Start ===== */
  renderWeek();
});
</script>
