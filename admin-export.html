<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ESS • SDP Admin Export</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="ESS Admin Export — Unified daily and weekly service logs." />
  <style>
    :root{
      --bg:#f7f8fb; --card:#fff; --ink:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --accent:#0f4c81; --radius:14px;
    }
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    header{
      background:#fff;border-bottom:1px solid var(--line);
      padding:16px;font-weight:800;font-size:20px;
    }
    .container{max-width:1200px;margin:28px auto;padding:0 18px}
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:var(--radius);
      padding:20px;margin-bottom:24px;
    }
    h2{margin:0 0 12px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid var(--line);padding:10px;text-align:left;font-size:14px}
    th{background:#f0f4fa;font-weight:700}
    input,select{
      padding:8px 10px;border:1px solid var(--line);border-radius:var(--radius);
      font-size:14px;width:100%;box-sizing:border-box;
    }
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:16px}
    button{
      background:var(--accent);color:#fff;border:none;padding:10px 16px;font-weight:700;
      border-radius:var(--radius);cursor:pointer
    }
    button:hover{opacity:.85}
    .btn-ghost{
      background:#fff;color:var(--ink);border:1px solid var(--line)
    }
    .muted{color:var(--muted)}
    .delete-btn{
      background:#b91c1c!important;
    }
  </style>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    const SUPA_URL = "https://bqanjupmcgydvmfgvutx.supabase.co";
    const SUPA_KEY = "YOUR_PUBLIC_ANON_KEY_HERE";  /* ← use your actual anon key */
    const supabase = createClient(SUPA_URL, SUPA_KEY);

    /* ---------------- DATE HELPERS ---------------- */
    const ymd = d => d.toISOString().slice(0,10);

    document.addEventListener("DOMContentLoaded", () => {
      /* DAILY SELECTS */
      window.cl_daily = document.getElementById("cl_daily");
      window.dt_daily = document.getElementById("dt_daily");
      window.staff_daily = document.getElementById("staff_daily");
      window.code_daily = document.getElementById("code_daily");
      window.rc_daily = document.getElementById("rc_daily");
      window.sc_daily = document.getElementById("sc_daily");

      /* WEEKLY SELECTS */
      window.wk_client = document.getElementById("wk_client");
      window.wk_weekDate = document.getElementById("wk_weekDate");
      window.wk_staff = document.getElementById("wk_staff");

      loadClients();
      loadStaff();
      loadDailyButton();
      loadWeeklyButton();
    });

    /* ---------------- LOAD DATA ---------------- */
    async function loadClients(){
      const { data } = await supabase.from("clients").select("*").order("name");
      for(const c of data){
        cl_daily.innerHTML += `<option value="${c.id}">${c.name}</option>`;
        wk_client.innerHTML += `<option value="${c.id}">${c.name}</option>`;
      }
    }

    async function loadStaff(){
      const { data } = await supabase.from("staff").select("*").order("name");
      for(const s of data){
        staff_daily.innerHTML += `<option value="${s.id}">${s.name}</option>`;
        wk_staff.innerHTML += `<option value="${s.id}">${s.name}</option>`;
      }
    }

    /* ---------------- DAILY EXPORT ---------------- */
    function loadDailyButton(){
      document.getElementById("btnLoadDaily")
        .addEventListener("click", loadDay);
    }

    async function loadDay(){
      const cid = cl_daily.value;
      const date = dt_daily.value;

      if(!cid || !date){
        alert("Select client + date");
        return;
      }

      const { data, error } = await supabase
        .from("daily_entries")
        .select("*")
        .eq("client_id", cid)
        .eq("service_date", date)
        .order("start");

      renderDailyTable(data);
    }

    function renderDailyTable(rows){
      const out = document.getElementById("dailyOut");
      if(!rows.length){
        out.innerHTML = `<p class="muted">No day loaded.</p>`;
        return;
      }

      out.innerHTML = `
      <table>
        <tr>
          <th>Date</th><th>Start</th><th>End</th><th>Hours</th>
          <th>Modality</th><th>Domains</th><th>RC</th>
          <th>SC</th><th>Staff Sig</th><th>Client Sig</th><th>Source</th>
        </tr>
        ${rows.map(r=>`
          <tr>
            <td>${r.service_date}</td>
            <td>${r.start||""}</td>
            <td>${r.end||""}</td>
            <td>${r.hours||""}</td>
            <td>${r.modality||""}</td>
            <td>${r.domains||""}</td>
            <td>${r.regional_center||""}</td>
            <td>${r.sc||""}</td>
            <td>${r.staff_signature||""}</td>
            <td>${r.client_signature||""}</td>
            <td>${r.source||""}</td>
          </tr>`).join("")}
      </table>`;
    }

    /* ---------------- WEEKLY EXPORT ---------------- */

    function loadWeeklyButton(){
      document.getElementById("btnLoadWeekly")
        .addEventListener("click", loadWeekly);
    }

    async function loadWeekly(){
      const cid = wk_client.value;
      const weekDate = wk_weekDate.value;   /* ← EXACT date chosen by staff */
      const sid = wk_staff.value;

      if(!cid || !weekDate){
        alert("Select client + week date");
        return;
      }

      let q = supabase
        .from("weekly_staff_plans")
        .select("*")
        .eq("client_id", cid)
        .eq("week_start", weekDate);   /* ← FIXED: no more Monday conversion */

      if(sid) q = q.eq("staff_id", sid);

      const { data, error } = await q.order("created_at", { ascending: false });

      renderWeeklyTable(data);
    }

    function renderWeeklyTable(rows){
      const out = document.getElementById("weeklyOut");
      if(!rows.length){
        out.innerHTML = `<p class="muted">No weekly plans.</p>`;
        return;
      }

      out.innerHTML = `
      <table>
        <tr>
          <th>Week Start</th>
          <th>Client</th>
          <th>Staff</th>
          <th>Plan</th>
          <th>Delete</th>
        </tr>
        ${rows.map(r=>`
          <tr>
            <td>${r.week_start}</td>
            <td>${r.client_id}</td>
            <td>${r.staff_id}</td>
            <td style="white-space:pre-wrap">${r.plan_text||""}</td>
            <td><button class="delete-btn" onclick="delWeekly('${r.id}')">Delete</button></td>
          </tr>`).join("")}
      </table>`;
    }

    window.delWeekly = async function(id){
      if(!confirm("Delete this weekly plan?")) return;
      await supabase.from("weekly_staff_plans").delete().eq("id", id);
      loadWeekly();
    }
  </script>
</head>

<body>
<header>ESS • SDP Admin Export</header>

<div class="container">

  <!-- DAILY EXPORT -->
  <div class="card">
    <h2>Daily export</h2>

    <div class="row">
      <div><label>Client</label><select id="cl_daily"><option value="">— select client —</option></select></div>
      <div><label>Service Date</label><input type="date" id="dt_daily"/></div>
      <div><label>Staff (optional)</label><select id="staff_daily"><option value="">—</option></select></div>
      <div><label>Service Code (SDP)</label><input id="code_daily" placeholder="e.g. 520 — ILS / CI"/></div>
      <div><label>Regional Center</label><input id="rc_daily"/></div>
    </div>

    <div class="row">
      <div><label>Service Coordinator</label><input id="sc_daily"/></div>
      <div><button id="btnLoadDaily">Load Day</button></div>
    </div>

    <div id="dailyOut" style="margin-top:16px"></div>
  </div>

  <!-- WEEKLY EXPORT -->
  <div class="card">
    <h2>Weekly staff plans</h2>

    <div class="row">
      <div><label>Client</label><select id="wk_client"><option value="">— select client —</option></select></div>
      <div><label>Week (pick any day)</label><input type="date" id="wk_weekDate"/></div>
      <div><label>Staff (optional)</label><select id="wk_staff"><option value="">—</option></select></div>
    </div>

    <button id="btnLoadWeekly">Load Weekly Plans</button>

    <div id="weeklyOut" style="margin-top:16px"></div>
  </div>

</div>

</body>
</html>
