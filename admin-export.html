<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ESS • SDP Admin Export (Daily)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;background:#f3f4f6;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;color:#0f172a;}
    header{background:#111827;color:#fff;padding:14px 18px;display:flex;align-items:center;gap:14px;}
    header img{height:40px;}
    .wrap{max-width:1100px;margin:1.4rem auto;padding:0 1rem;}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:1rem 1.2rem;margin-bottom:1rem;}
    label{font-size:.75rem;font-weight:500;display:block;margin-bottom:3px;}
    input,select{padding:6px 9px;border:1px solid #d1d5db;border-radius:8px;font-size:.78rem;}
    button{border:none;border-radius:8px;padding:7px 12px;background:#111827;color:#fff;cursor:pointer;font-size:.78rem;}
    button.btn-muted{background:#e5e7eb;color:#111827;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:.75rem;}
    .flex{display:flex;gap:10px;flex-wrap:wrap;}

    /* ✅ make PDF area renderable but invisible */
    #printArea{
      position:fixed;
      inset:0;
      width:8.5in;
      max-width:8.5in;
      background:#fff;
      opacity:0;
      pointer-events:none;
      z-index:-1;
    }
  </style>
</head>
<body>
<header>
  <img src="https://empowermentss.com/logo.png" alt="ESS" onerror="this.style.display='none'">
  <div>
    <div style="font-weight:600;">Empowerment Support Solutions, LLC</div>
    <div style="font-size:.72rem;opacity:.7;">SDP • Service Log Export (Daily – Unified)</div>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h2 style="margin-top:0;">Daily export</h2>
    <div class="flex">
      <div>
        <label for="clientSelect">Client</label>
        <select id="clientSelect" style="min-width:220px;">
          <option value="">— loading clients… —</option>
        </select>
      </div>
      <div style="display:none;">
        <label for="clientId">Client ID / UUID</label>
        <input id="clientId" value="">
      </div>
      <div>
        <label for="serviceDate">Service Date</label>
        <input id="serviceDate" type="date">
      </div>
      <div>
        <label for="staffFilter">Staff (optional)</label>
        <input id="staffFilter" placeholder="e.g. Maria Perez">
      </div>
      <div>
        <label for="serviceCode">Service Code (SDP)</label>
        <input id="serviceCode" placeholder="e.g. 520 – ILS / CI">
      </div>
      <div>
        <label for="rcName">Regional Center</label>
        <input id="rcName" placeholder="">
      </div>
      <div>
        <label for="scName">Service Coordinator</label>
        <input id="scName" placeholder="">
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="loadDay">Load Day</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="exportDay" class="btn-muted" disabled>Export Day (Unified)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Day preview</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Start</th>
          <th>End</th>
          <th>Hours</th>
          <th>Modality</th>
          <th>Domains</th>
          <th>RC</th>
          <th>SC</th>
          <th>Staff Sig</th>
          <th>Client Sig</th>
          <th>Source</th>
        </tr>
      </thead>
      <tbody id="dayBody">
        <tr><td colspan="11">No day loaded.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- PDF render target -->
<div id="printArea"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
(async () => {
  const SUPABASE_URL = "https://bqanjupmcgydvmfgvutx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYW5qdXBtY2d5ZHZtZmd2dXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTI4NzQsImV4cCI6MjA3NjM4ODg3NH0.J3A12rwUlSqjIsmlnNCcwis6Qt_ryw7ZzFqLftuMKUk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const ess = sb.schema("ess");

  const clientSelect = document.getElementById("clientSelect");
  const clientIdInput = document.getElementById("clientId");
  const dateInput     = document.getElementById("serviceDate");
  const staffInput    = document.getElementById("staffFilter");
  const serviceInput  = document.getElementById("serviceCode");
  const rcInput       = document.getElementById("rcName");
  const scInput       = document.getElementById("scName");
  const dayBody       = document.getElementById("dayBody");
  const btnLoad       = document.getElementById("loadDay");
  const btnExport     = document.getElementById("exportDay");
  const printArea     = document.getElementById("printArea");

  // default date = today
  const today = new Date();
  dateInput.value = today.toISOString().slice(0,10);

  let currentDayData = null;

  async function loadClients() {
    let options = [];
    let { data: clients, error } = await ess.from("clients").select("id, full_name").order("full_name",{ascending:true});
    if (!error && Array.isArray(clients) && clients.length) {
      options = clients.map(c => ({ id: c.id, label: c.full_name || c.id }));
    } else {
      const collected = new Map();
      const { data: e1 } = await ess.from("daily_entries").select("client_id").limit(2000);
      (e1||[]).forEach(r => { if (r.client_id) collected.set(r.client_id, true); });
      const { data: e2 } = await ess.from("daily_drafts").select("client_id").limit(2000);
      (e2||[]).forEach(r => { if (r.client_id) collected.set(r.client_id, true); });
      options = Array.from(collected.keys()).map(id => ({ id, label: "Client – " + id.slice(0,8) }));
    }
    clientSelect.innerHTML = "";
    if (!options.length) {
      clientSelect.innerHTML = `<option value="">— no clients found —</option>`;
    } else {
      clientSelect.innerHTML = `<option value="">— select client —</option>` +
        options.map(o => `<option value="${o.id}">${o.label}</option>`).join("");
    }
  }
  await loadClients();

  clientSelect.addEventListener("change", () => {
    clientIdInput.value = clientSelect.value || "";
  });

  async function resolveStaffIdByName(name) {
    if (!name) return null;
    const { data, error } = await ess.from("staff").select("id").eq("full_name", name).maybeSingle();
    if (!error && data?.id) return data.id;
    return null;
  }

  async function loadDay() {
    const clientId = clientIdInput.value.trim();
    if (!clientId) { alert("Select a client first."); return; }

    const serviceDate = dateInput.value;
    if (!serviceDate) { alert("Pick a service date."); return; }

    const staffName = staffInput.value.trim();
    let staffIdFilter = null;
    if (staffName) staffIdFilter = await resolveStaffIdByName(staffName);

    // 1) try daily_entries (official)
    let q = ess.from("daily_entries").select("*").eq("client_id", clientId).eq("service_date", serviceDate).limit(10);
    if (staffIdFilter) q = q.eq("staff_id", staffIdFilter);
    const { data: officialRows } = await q;
    let official = Array.isArray(officialRows) && officialRows.length ? officialRows[0] : null;

    // 2) drafts
    let draft = null;
    const { data: draftRows } = await ess.from("daily_drafts").select("*").eq("client_id", clientId).eq("date", serviceDate).limit(10);
    if (Array.isArray(draftRows) && draftRows.length) {
      draft = draftRows[0];
    }

    if (!official && !draft) {
      dayBody.innerHTML = `<tr><td colspan="11">No data for this date.</td></tr>`;
      currentDayData = null;
      btnExport.disabled = true;
      return;
    }

    const merged = {
      clientId,
      clientLabel: clientSelect.options[clientSelect.selectedIndex]?.text || clientId,
      date: serviceDate,
      start_time: official?.start_time || draft?.start_time || "",
      end_time: official?.end_time || draft?.end_time || "",
      hours: (official && official.hours != null) ? official.hours
             : (draft && draft.hours != null) ? draft.hours
             : "",
      modality: official?.modality || draft?.modality || "",
      domain: (() => {
        if (official?.activities) {
          return Array.isArray(official.activities) ? official.activities.join(", ") : official.activities;
        }
        return draft?.activities || "";
      })(),
      notes: official?.service_notes || draft?.notes || "",
      staff_signature: official?.staff_signature || draft?.staff_signature || "",
      client_signature: official?.client_signature || draft?.client_signature || "",
      regional_center: official?.regional_center || draft?.regional_center || (rcInput.value || ""),
      service_coordinator: official?.service_coordinator || draft?.service_coordinator || (scInput.value || ""),
      source: official ? "official" : "draft",
      staffName: staffName
    };

    currentDayData = merged;

    dayBody.innerHTML = `
      <tr>
        <td>${new Intl.DateTimeFormat('en-US',{month:'short',day:'2-digit',year:'numeric'}).format(new Date(serviceDate))}</td>
        <td>${merged.start_time || "—"}</td>
        <td>${merged.end_time || "—"}</td>
        <td>${merged.hours !== "" ? Number(merged.hours).toFixed(2) : "—"}</td>
        <td>${merged.modality || "—"}</td>
        <td>${merged.domain || "—"}</td>
        <td>${merged.regional_center || "—"}</td>
        <td>${merged.service_coordinator || "—"}</td>
        <td>${merged.staff_signature ? "✅" : "—"}</td>
        <td>${merged.client_signature ? "✅" : "—"}</td>
        <td>${merged.source}</td>
      </tr>
    `;

    btnExport.disabled = false;
  }

  btnLoad.addEventListener("click", loadDay);

  async function exportDay() {
    if (!currentDayData) return;
    const {
      clientLabel, date, start_time, end_time, hours, modality,
      domain, notes, staff_signature, client_signature,
      regional_center, service_coordinator, staffName, source
    } = currentDayData;

    const businessName = "Empowerment Support Solutions, LLC";
    const contactLine  = "empowermentss.com • (562) 000-0000 • info@empowermentss.com";
    const serviceCode  = serviceInput.value || "SDP Service Code";

    const fmt = (d)=>new Intl.DateTimeFormat('en-US',{month:'short',day:'2-digit',year:'numeric'}).format(new Date(d));

    // 1) build HTML inside visible-but-hidden container
    printArea.innerHTML = `
      <div style="width:8.5in;min-height:11in;padding:0.6in 0.6in;background:#fff;font-family:system-ui,-apple-system,'Segoe UI',sans-serif;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
          <div>
            <div style="font-size:15px;font-weight:700;">${businessName}</div>
            <div style="font-size:11px;">SDP – Daily Service Log (Unified: RC / SC / FMS)</div>
            <div style="font-size:11px;margin-top:4px;"><strong>Client:</strong> ${clientLabel}</div>
            <div style="font-size:11px;"><strong>Service Date:</strong> ${fmt(date)}</div>
            <div style="font-size:11px;"><strong>Staff:</strong> ${staffName || "—"}</div>
            <div style="font-size:11px;"><strong>Service Code:</strong> ${serviceCode}</div>
            <div style="font-size:11px;"><strong>Regional Center:</strong> ${regional_center || "—"}</div>
            <div style="font-size:11px;"><strong>Service Coordinator:</strong> ${service_coordinator || "—"}</div>
          </div>
          <div>
            <img src="https://empowermentss.com/logo.png" style="height:60px;" onerror="this.style.display='none'">
          </div>
        </div>

        <div style="border:1px solid #e5e7eb;border-radius:8px;margin-bottom:10px;padding:8px 10px;">
          <div style="font-size:11.5px;margin-bottom:4px;"><strong>Time In:</strong> ${start_time || "—"} &nbsp; <strong>Time Out:</strong> ${end_time || "—"} &nbsp; <strong>Hours:</strong> ${hours !== "" ? Number(hours).toFixed(2) : "—"}</div>
          <div style="font-size:11.5px;margin-bottom:4px;"><strong>Location / Modality:</strong> ${modality || "—"}</div>
          <div style="font-size:11.5px;margin-bottom:4px;"><strong>Service / Domain:</strong> ${domain || "—"}</div>
          <div style="font-size:11.5px;margin-bottom:4px;"><strong>Source:</strong> ${source}</div>
          <div style="font-size:11.5px;margin-top:6px;"><strong>Description / Progress:</strong></div>
          <div style="border:1px solid #e5e7eb;border-radius:6px;padding:5px 6px;white-space:pre-wrap;font-size:11px;min-height:60px;">
            ${notes || "No note entered."}
          </div>
          <div style="display:flex;gap:20px;margin-top:10px;align-items:flex-end;">
            <div>
              <div style="font-size:10.5px;font-weight:600;">Staff Signature:</div>
              ${staff_signature
                ? `<img src="${staff_signature}" style="width:180px;height:50px;object-fit:contain;border-bottom:1px solid #000;">`
                : `<div style="width:180px;height:50px;border-bottom:1px solid #000;"></div>`}
            </div>
            <div>
              <div style="font-size:10.5px;font-weight:600;">Participant / Parent:</div>
              ${client_signature
                ? `<img src="${client_signature}" style="width:180px;height:50px;object-fit:contain;border-bottom:1px solid #000;">`
                : `<div style="width:180px;height:50px;border-bottom:1px solid #000;"></div>`}
            </div>
          </div>
        </div>

        <div style="margin-top:14px;font-size:9.5px;line-height:1.35;">
          I certify that the services listed above were actually provided to the participant in accordance with the participant’s Individual Program Plan (IPP) and Self-Determination Program Spending Plan, and that the hours and dates reported are accurate.
        </div>

        <div style="display:flex;gap:40px;margin-top:16px;">
          <div>
            <div style="width:210px;border-bottom:1px solid #000;height:46px;"></div>
            <div style="font-size:9.5px;margin-top:3px;">Staff / Provider Signature &nbsp;&nbsp; Date: ___________</div>
          </div>
          <div>
            <div style="width:210px;border-bottom:1px solid #000;height:46px;"></div>
            <div style="font-size:9.5px;margin-top:3px;">Participant / Parent / Authorized Rep &nbsp;&nbsp; Date: ___________</div>
          </div>
        </div>

        <div style="margin-top:18px;font-size:9px;color:#6b7280;">
          ${businessName} • ${contactLine}
        </div>
      </div>
    `;

    /* 2) let browser paint it once so html2canvas sees it */
    await new Promise(res => requestAnimationFrame(res));

    /* 3) export */
    const opt = {
      margin: 0,
      filename: `ESS_${clientLabel.replace(/\s+/g,"_")}_${date}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, allowTaint: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    await html2pdf().set(opt).from(printArea).save();
  }

  btnExport.addEventListener("click", exportDay);
})();
</script>
</body>
</html>
