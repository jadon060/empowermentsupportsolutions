<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ESS ‚Ä¢ SDP Admin Export (Daily)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;background:#f3f4f6;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;color:#0f172a;}
    header{background:#111827;color:#fff;padding:14px 18px;display:flex;align-items:center;gap:14px;}
    header img{height:40px;}
    .wrap{max-width:1100px;margin:1.4rem auto;padding:0 1rem;}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:1rem 1.2rem;margin-bottom:1rem;}
    label{font-size:.75rem;font-weight:500;display:block;margin-bottom:3px;}
    input,select{padding:6px 9px;border:1px solid #d1d5db;border-radius:8px;font-size:.78rem;}
    button{border:none;border-radius:8px;padding:7px 12px;background:#111827;color:#fff;cursor:pointer;font-size:.78rem;}
    button.btn-muted{background:#e5e7eb;color:#111827;}
    table{width:100%;border-collapse:collapse;}
    th,td{padding:6px 8px;border-bottom:1px solid #e5e7eb;text-align:left;font-size:.75rem;vertical-align:top;}
    .flex{display:flex;gap:10px;flex-wrap:wrap;}
    .trash-btn{
      background:transparent;
      border:none;
      cursor:pointer;
      font-size:14px;
      line-height:1;
      padding:2px 4px;
      color:#ef4444;
    }
    .trash-btn:hover{color:#b91c1c;}
  </style>
</head>
<body>
<header>
  <img src="https://raw.githubusercontent.com/jadon060/empowermentsupportsolutions/main/logo%20full.png" alt="ESS" onerror="this.style.display='none'">
  <div>
    <div style="font-weight:600;">Empowerment Support Solutions, LLC</div>
    <div style="font-size:.72rem;opacity:.7;">SDP ‚Ä¢ Service Log Export (Daily ‚Äì Unified)</div>
  </div>
</header>

<div class="wrap">
  <!-- DAILY -->
  <div class="card">
    <h2 style="margin-top:0;">Daily export</h2>
    <div class="flex">
      <div>
        <label for="clientSelect">Client</label>
        <select id="clientSelect" style="min-width:220px;">
          <option value="">‚Äî loading clients‚Ä¶ ‚Äî</option>
        </select>
      </div>
      <div style="display:none;">
        <label for="clientId">Client ID / UUID</label>
        <input id="clientId" value="">
      </div>
      <div>
        <label for="serviceDate">Service Date</label>
        <input id="serviceDate" type="date">
      </div>
      <div>
        <label for="staffFilter">Staff (optional)</label>
        <input id="staffFilter" placeholder="e.g. John Perez">
      </div>
      <div>
        <label for="serviceCode">Service Code (SDP)</label>
        <input id="serviceCode" placeholder="e.g. 520 ‚Äì ILS / CI">
      </div>
      <div>
        <label for="rcName">Regional Center</label>
        <input id="rcName" placeholder="">
      </div>
      <div>
        <label for="scName">Service Coordinator</label>
        <input id="scName" placeholder="">
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="loadDay">Load Day</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="exportDay" class="btn-muted" disabled>Export Day (Unified)</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-top:0;">Day preview</h3>
    <table>
      <thead>
        <tr>
          <th>Date</th>
          <th>Start</th>
          <th>End</th>
          <th>Hours</th>
          <th>Modality</th>
          <th>Domains</th>
          <th>RC</th>
          <th>SC</th>
          <th>Staff Sig</th>
          <th>Client Sig</th>
          <th>Source</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="dayBody">
        <tr><td colspan="12">No day loaded.</td></tr>
      </tbody>
    </table>
  </div>

  <!-- WEEKLY (new) -->
  <div class="card">
    <h2 style="margin-top:0;">Weekly staff plans</h2>
    <div class="flex">
      <div>
        <label for="wk_clientSelect">Client</label>
        <select id="wk_clientSelect" style="min-width:220px;">
          <option value="">‚Äî select client ‚Äî</option>
        </select>
      </div>
      <div>
        <label for="wk_weekDate">Week of (pick any day)</label>
        <input id="wk_weekDate" type="date">
      </div>
      <div>
        <label for="wk_staffFilter">Staff (optional)</label>
        <input id="wk_staffFilter" placeholder="e.g. John Perez">
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="wk_load">Load Weekly Plans</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="wk_export" class="btn-muted" disabled>Export Weekly Plan</button>
      </div>
    </div>
  </div>

  <div class="card" id="wk_resultsCard" style="display:none;">
    <h3 style="margin-top:0;">Weekly plans for selected client</h3>
    <table>
      <thead>
        <tr>
          <th>Staff</th>
          <th>Week start</th>
          <th>Mon</th>
          <th>Tue</th>
          <th>Wed</th>
          <th>Thu</th>
          <th>Fri</th>
          <th>Sat</th>
          <th>Sun</th>
          <th>Signature</th>
        </tr>
      </thead>
      <tbody id="wk_body">
        <tr><td colspan="10">No weekly plan loaded.</td></tr>
      </tbody>
    </table>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(async () => {
  const SUPABASE_URL = "https://bqanjupmcgydvmfgvutx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYW5qdXBtY2d5ZHZtZmd2dXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTI4NzQsImV4cCI6MjA3NjM4ODg3NH0.J3A12rwUlSqjIsmlnNCcwis6Qt_ryw7ZzFqLftuMKUk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const ess = sb.schema("ess");

  const clientSelect = document.getElementById("clientSelect");
  const clientIdInput = document.getElementById("clientId");
  const dateInput     = document.getElementById("serviceDate");
  const staffInput    = document.getElementById("staffFilter");
  const serviceInput  = document.getElementById("serviceCode");
  const rcInput       = document.getElementById("rcName");
  const scInput       = document.getElementById("scName");
  const dayBody       = document.getElementById("dayBody");
  const btnLoad       = document.getElementById("loadDay");
  const btnExport     = document.getElementById("exportDay");

  // weekly elems
  const wk_clientSelect = document.getElementById("wk_clientSelect");
  const wk_weekDate     = document.getElementById("wk_weekDate");
  const wk_staffFilter  = document.getElementById("wk_staffFilter");
  const wk_load         = document.getElementById("wk_load");
  const wk_export       = document.getElementById("wk_export");
  const wk_resultsCard  = document.getElementById("wk_resultsCard");
  const wk_body         = document.getElementById("wk_body");

  const LOGO_URL = "https://raw.githubusercontent.com/jadon060/empowermentsupportsolutions/main/logo%20full.png";
  const CONTACT_LINE = "(626) 596-6155 ‚Ä¢ empowermentess@gmail.com";

  const today = new Date();
  dateInput.value = today.toISOString().slice(0,10);
  wk_weekDate.value = today.toISOString().slice(0,10);

  let currentDayData = null;
  let currentWeeklyRows = [];

  async function loadClients() {
    let options = [];
    try {
      let { data: clients, error } = await ess.from("clients").select("id, full_name").order("full_name",{ascending:true});
      if (!error && Array.isArray(clients) && clients.length) {
        options = clients.map(c => ({ id: c.id, label: c.full_name || c.id }));
      } else {
        const collected = new Map();
        const { data: e1 } = await ess.from("daily_entries").select("client_id").limit(2000);
        (e1||[]).forEach(r => { if (r.client_id) collected.set(r.client_id, true); });
        const { data: e2 } = await ess.from("daily_drafts").select("client_id").limit(2000);
        (e2||[]).forEach(r => { if (r.client_id) collected.set(r.client_id, true); });
        options = Array.from(collected.keys()).map(id => ({ id, label: "Client ‚Äì " + id.slice(0,8) }));
      }
    } catch (err) {
      console.error("Client load error:", err);
    }

    const html = options.length
      ? `<option value="">‚Äî select client ‚Äî</option>` + options.map(o => `<option value="${o.id}">${o.label}</option>`).join("")
      : `<option value="">‚Äî no clients found ‚Äî</option>`;

    clientSelect.innerHTML = html;
    wk_clientSelect.innerHTML = html;
  }
  await loadClients();

  clientSelect.addEventListener("change", () => { clientIdInput.value = clientSelect.value || ""; });

  async function resolveStaffIdByName(name) {
    if (!name) return null;
    const { data } = await ess.from("staff").select("id").eq("full_name", name).maybeSingle();
    return data?.id || null;
  }

  function splitNotes(raw) {
    if (!raw) return { progress: "", observation: "", action: "" };
    const P = "## Progress Notes:", O = "## Observation:", A = "## Action Plan:";
    let progress="", observation="", action="";
    if (raw.includes(P)) {
      const pIdx = raw.indexOf(P)+P.length;
      const oIdx = raw.indexOf(O,pIdx);
      const aIdx = raw.indexOf(A,oIdx>-1?oIdx:pIdx);
      progress = raw.slice(pIdx, oIdx>-1?oIdx:(aIdx>-1?aIdx:raw.length)).trim();
      if (oIdx>-1) observation = raw.slice(oIdx+O.length, aIdx>-1?aIdx:raw.length).trim();
      if (aIdx>-1) action = raw.slice(aIdx+A.length).trim();
      return {progress,observation,action};
    }
    return {progress:raw.trim(),observation:"",action:""};
  }

  function to12h(t){ if(!t) return "‚Äî"; const parts=t.split(":"); let h=parseInt(parts[0],10); const m=parts[1]??"00"; const ampm=h>=12?"PM":"AM"; h=h%12; if(h===0)h=12; return `${h}:${m.padStart(2,"0")} ${ampm}`; }
  function computeHours(start,end){ if(!start||!end) return ""; const [sh,sm]=start.split(":").map(Number); const [eh,em]=end.split(":").map(Number); const diff=(eh*60+(em||0))-(sh*60+(sm||0)); if(diff<=0) return ""; return (diff/60).toFixed(2); }
  function startOfWeekMonday(d){const nd=new Date(d.getFullYear(),d.getMonth(),d.getDate());const day=nd.getDay();const diff=(day===0?-6:1-day);nd.setDate(nd.getDate()+diff);nd.setHours(0,0,0,0);return nd;}
  const ymd = d => d.toISOString().slice(0,10);

  async function loadDay() {
    const clientId = clientIdInput.value.trim();
    if (!clientId) { alert("Select a client first."); return; }
    const serviceDate = dateInput.value;
    if (!serviceDate) { alert("Pick a service date."); return; }

    const staffName = staffInput.value.trim();
    let staffIdFilter = null;
    if (staffName) staffIdFilter = await resolveStaffIdByName(staffName);

    let { data: officialRows } = await ess.from("daily_entries")
      .select("*")
      .eq("client_id", clientId)
      .eq("service_date", serviceDate)
      .maybeSingle()
      .then(r => ({ data: r.data ? [r.data] : [] }));

    let official = Array.isArray(officialRows) && officialRows.length ? officialRows[0] : null;
    if (official && staffIdFilter && official.staff_id !== staffIdFilter) official = null;

    const { data: draftRows } = await ess.from("daily_drafts")
      .select("*")
      .eq("client_id", clientId)
      .eq("date", serviceDate);

    let draft = Array.isArray(draftRows) && draftRows.length ? draftRows[0] : null;
    if (draft && staffIdFilter && draft.staff_id && draft.staff_id !== staffIdFilter) draft = null;

    if (!official && !draft) {
      dayBody.innerHTML = `<tr><td colspan="12">No data for this date.</td></tr>`;
      currentDayData = null;
      btnExport.disabled = true;
      return;
    }

    const start_time = official?.start_time || draft?.start_time || "";
    const end_time   = official?.end_time   || draft?.end_time   || "";
    let hours        = (official && official.hours != null) ? official.hours
                      : (draft && draft.hours != null) ? draft.hours
                      : "";
    if (!hours) {
      const computed = computeHours(start_time,end_time);
      if (computed) hours = computed;
    }

    const merged = {
      clientId,
      clientLabel: clientSelect.options[clientSelect.selectedIndex]?.text || clientId,
      date: serviceDate,
      start_time,
      end_time,
      hours,
      modality: official?.modality || draft?.modality || "",
      domain: official?.activities ? (Array.isArray(official.activities)?official.activities.join(", "):official.activities) : (draft?.activities || ""),
      notes: official?.service_notes || draft?.notes || "",
      staff_signature: official?.staff_signature || draft?.staff_signature || "",
      client_signature: official?.client_signature || draft?.client_signature || "",
      regional_center: official?.regional_center || draft?.regional_center || (rcInput.value || ""),
      service_coordinator: official?.service_coordinator || draft?.service_coordinator || (scInput.value || ""),
      source: official ? "official" : "draft",
      staffName,
      staffId: official?.staff_id || draft?.staff_id || staffIdFilter || null
    };

    currentDayData = merged;

    dayBody.innerHTML = `
      <tr>
        <td>${new Intl.DateTimeFormat('en-US',{month:'short',day:'2-digit',year:'numeric'}).format(new Date(serviceDate))}</td>
        <td>${merged.start_time ? to12h(merged.start_time) : "‚Äî"}</td>
        <td>${merged.end_time ? to12h(merged.end_time) : "‚Äî"}</td>
        <td>${merged.hours !== "" ? Number(merged.hours).toFixed(2) : "‚Äî"}</td>
        <td>${merged.modality || "‚Äî"}</td>
        <td>${merged.domain || "‚Äî"}</td>
        <td>${merged.regional_center || "‚Äî"}</td>
        <td>${merged.service_coordinator || "‚Äî"}</td>
        <td>${merged.staff_signature ? "‚úÖ" : "‚Äî"}</td>
        <td>${merged.client_signature ? "‚úÖ" : "‚Äî"}</td>
        <td>${merged.source}</td>
        <td><button class="trash-btn" onclick="window.__essDeleteDay && window.__essDeleteDay()">üóëÔ∏è</button></td>
      </tr>
    `;
    btnExport.disabled = false;
  }
  btnLoad.addEventListener("click", loadDay);

  window.__essDeleteDay = async function(){
    if (!currentDayData) return;
    const ok = confirm("Delete this day's entry for this client?");
    if (!ok) return;
    const { clientId, date, staffId } = currentDayData;
    let delOfficial = ess.from("daily_entries").delete().eq("client_id", clientId).eq("service_date", date);
    if (staffId) delOfficial = delOfficial.eq("staff_id", staffId);
    await delOfficial;
    let delDraft = ess.from("daily_drafts").delete().eq("client_id", clientId).eq("date", date);
    if (staffId) delDraft = delDraft.eq("staff_id", staffId);
    await delDraft;
    dayBody.innerHTML = `<tr><td colspan="12">No data for this date.</td></tr>`;
    currentDayData = null;
    btnExport.disabled = true;
    alert("Day deleted ‚úÖ");
  };

  function exportDay(){
    if (!currentDayData) return;
    const {
      clientLabel, date, start_time, end_time, hours, modality,
      domain, notes, staff_signature, client_signature,
      regional_center, service_coordinator, staffName, source
    } = currentDayData;

    const businessName = "Empowerment Support Solutions, LLC";
    const serviceCode  = serviceInput.value || "SDP Service Code";
    const fmt = (d)=>new Intl.DateTimeFormat('en-US',{month:'short',day:'2-digit',year:'numeric'}).format(new Date(d));
    const { progress, observation, action } = splitNotes(notes);
    const start12 = start_time ? to12h(start_time) : "‚Äî";
    const end12   = end_time ? to12h(end_time) : "‚Äî";
    const hoursStr = (hours !== "" && hours !== null) ? Number(hours).toFixed(2) : "‚Äî";

    const win = window.open("", "_blank", "width=900,height=1100");
    win.document.write(`
      <html>
      <head>
        <title>ESS_${clientLabel.replace(/\s+/g,"_")}_${date}.pdf</title>
        <style>
          body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:0;padding:0;background:#fff;}
          .page{width:8.5in;min-height:11in;margin:0 auto;padding:0.5in;box-sizing:border-box;}
          .header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
          .header-left{max-width:70%;}
          .logo{height:90px;object-fit:contain;}
          .box{border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px;margin-bottom:10px;}
          img.sig{width:180px;height:50px;object-fit:contain;border-bottom:1px solid #000;}
          .section-title{font-weight:600;font-size:11px;margin-top:6px;margin-bottom:3px;}
          .note-box{border:1px solid #e5e7eb;border-radius:6px;padding:4px 6px;min-height:40px;font-size:11px;white-space:pre-wrap;}
          @media print { body{background:#fff;} .page{margin:0;} }
        </style>
      </head>
      <body>
        <div class="page">
          <div class="header">
            <div class="header-left">
              <div style="font-size:15px;font-weight:700;">${businessName}</div>
              <div style="font-size:11px;">SDP ‚Äì Daily Service Log (Unified: RC / SC / FMS)</div>
              <div style="font-size:11px;margin-top:4px;"><strong>Client:</strong> ${clientLabel}</div>
              <div style="font-size:11px;"><strong>Service Date:</strong> ${fmt(date)}</div>
              <div style="font-size:11px;"><strong>Staff:</strong> ${staffName || "‚Äî"}</div>
              <div style="font-size:11px;"><strong>Service Code:</strong> ${serviceCode}</div>
              <div style="font-size:11px;"><strong>Regional Center:</strong> ${regional_center || "‚Äî"}</div>
              <div style="font-size:11px;"><strong>Service Coordinator:</strong> ${service_coordinator || "‚Äî"}</div>
            </div>
            <div>
              <img src="${LOGO_URL}" class="logo" onerror="this.style.display='none'">
              <div style="font-size:10px;color:#94a3b8;text-align:right;margin-top:4px;">ESS ‚Ä¢ Daily export</div>
            </div>
          </div>

          <div class="box">
            <div style="font-size:11.5px;margin-bottom:4px;">
              <strong>Time In:</strong> ${start12} &nbsp;
              <strong>Time Out:</strong> ${end12} &nbsp;
              <strong>Hours:</strong> ${hoursStr}
            </div>
            <div style="font-size:11.5px;margin-bottom:4px;"><strong>Location / Modality:</strong> ${modality || "‚Äî"}</div>
            <div style="font-size:11.5px;margin-bottom:4px;"><strong>Service / Domain:</strong> ${domain || "‚Äî"}</div>
            <div style="font-size:11.5px;margin-bottom:6px;"><strong>Source:</strong> ${source}</div>

            <div class="section-title">Description / Progress:</div>
            <div class="note-box">${progress || "‚Äî"}</div>

            <div class="section-title">Observation:</div>
            <div class="note-box">${observation || "‚Äî"}</div>

            <div class="section-title">Action Plan:</div>
            <div class="note-box">${action || "‚Äî"}</div>

            <div style="display:flex;gap:20px;margin-top:10px;align-items:flex-end;">
              <div>
                <div style="font-size:10.5px;font-weight:600;">Staff Signature:</div>
                ${ staff_signature
                    ? `<img class="sig" src="${staff_signature}">`
                    : `<div style="width:180px;height:50px;border-bottom:1px solid #000;"></div>` }
              </div>
              <div>
                <div style="font-size:10.5px;font-weight:600;">Participant / Parent:</div>
                ${ client_signature
                    ? `<img class="sig" src="${client_signature}">`
                    : `<div style="width:180px;height:50px;border-bottom:1px solid #000;"></div>` }
              </div>
            </div>
          </div>

          <div style="margin-top:12px;font-size:9.5px;line-height:1.35;">
            I certify that the services listed above were actually provided to the participant in accordance with the participant‚Äôs Individual Program Plan (IPP) and Self-Determination Program Spending Plan, and that the hours and dates reported are accurate.
          </div>

          <div style="margin-top:14px;font-size:9px;color:#6b7280;">
            ${businessName} ‚Ä¢ ${CONTACT_LINE}
          </div>
        </div>
      </body>
      </html>
    `);
    win.document.close();
    win.focus();
    setTimeout(() => win.print(), 400);
  }
  btnExport.addEventListener("click", exportDay);

  // ===== WEEKLY JS =====
  async function staffNameById(id){
    if (!id) return "";
    const { data } = await ess.from("staff").select("full_name").eq("id", id).maybeSingle();
    return data?.full_name || id;
  }

  async function loadWeekly(){
    const clientId = wk_clientSelect.value;
    if (!clientId){ alert("Pick a client first."); return; }

    const picked = wk_weekDate.value ? new Date(wk_weekDate.value) : new Date();
    const monday = startOfWeekMonday(picked);
    const mondayStr = ymd(monday);

    const staffNameFilter = wk_staffFilter.value.trim();
    let staffIdFilter = null;
    if (staffNameFilter){
      const { data } = await ess.from("staff").select("id").eq("full_name", staffNameFilter).maybeSingle();
      staffIdFilter = data?.id || null;
    }

    const { data, error } = await ess.from("weekly_staff_plans")
      .select("*")
      .eq("client_id", clientId)
      .eq("week_start", mondayStr);

    if (error){
      alert(error.message);
      return;
    }

    let rows = data || [];
    if (staffIdFilter){
      rows = rows.filter(r => r.staff_id === staffIdFilter);
    }

    if (!rows.length){
      wk_resultsCard.style.display = "block";
      wk_body.innerHTML = `<tr><td colspan="10">No weekly plans for this client and week.</td></tr>`;
      currentWeeklyRows = [];
      wk_export.disabled = true;
      return;
    }

    for (const r of rows){
      r.__staff_name = await staffNameById(r.staff_id);
    }

    wk_resultsCard.style.display = "block";
    wk_body.innerHTML = rows.map(r => `
      <tr>
        <td>${r.__staff_name}</td>
        <td>${r.week_start}</td>
        <td>${r.mon_text || ""}</td>
        <td>${r.tue_text || ""}</td>
        <td>${r.wed_text || ""}</td>
        <td>${r.thu_text || ""}</td>
        <td>${r.fri_text || ""}</td>
        <td>${r.sat_text || ""}</td>
        <td>${r.sun_text || ""}</td>
        <td>${r.staff_signature ? "‚úÖ" : "‚Äî"}</td>
      </tr>
    `).join("");

    currentWeeklyRows = rows;
    wk_export.disabled = false;
  }
  wk_load.addEventListener("click", loadWeekly);

  function exportWeekly(){
    if (!currentWeeklyRows.length) return;
    const clientLabel = wk_clientSelect.options[wk_clientSelect.selectedIndex]?.text || "Client";
    const weekStart = currentWeeklyRows[0].week_start;
    const win = window.open("", "_blank", "width=900,height=1100");
    win.document.write(`
      <html>
      <head>
        <title>ESS_${clientLabel.replace(/\s+/g,"_")}_weekly_${weekStart}.pdf</title>
        <style>
          body{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;margin:0;padding:0;}
          .page{width:8.5in;margin:0 auto;padding:0.5in;box-sizing:border-box;}
          table{width:100%;border-collapse:collapse;font-size:11px;}
          th,td{border:1px solid #e5e7eb;padding:6px;vertical-align:top;}
          .head{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;}
          .sig{width:180px;height:50px;object-fit:contain;border-bottom:1px solid #000;}
        </style>
      </head>
      <body>
        <div class="page">
          <div class="head">
            <div>
              <h2>Weekly Staff Plans</h2>
              <div><strong>Client:</strong> ${clientLabel}</div>
              <div><strong>Week start:</strong> ${weekStart}</div>
            </div>
            <div>
              <img src="${LOGO_URL}" style="height:70px;" onerror="this.style.display='none'">
            </div>
          </div>
          <table>
            <thead>
              <tr>
                <th>Staff</th>
                <th>Mon</th>
                <th>Tue</th>
                <th>Wed</th>
                <th>Thu</th>
                <th>Fri</th>
                <th>Sat</th>
                <th>Sun</th>
                <th>Signature</th>
              </tr>
            </thead>
            <tbody>
              ${
                currentWeeklyRows.map(r => `
                  <tr>
                    <td>${r.__staff_name}</td>
                    <td>${(r.mon_text||"").replace(/\n/g,"<br>")}</td>
                    <td>${(r.tue_text||"").replace(/\n/g,"<br>")}</td>
                    <td>${(r.wed_text||"").replace(/\n/g,"<br>")}</td>
                    <td>${(r.thu_text||"").replace(/\n/g,"<br>")}</td>
                    <td>${(r.fri_text||"").replace(/\n/g,"<br>")}</td>
                    <td>${(r.sat_text||"").replace(/\n/g,"<br>")}</td>
                    <td>${(r.sun_text||"").replace(/\n/g,"<br>")}</td>
                    <td>${
                      r.staff_signature
                        ? `<img class="sig" src="${r.staff_signature}">`
                        : `<div style="width:180px;height:50px;border-bottom:1px solid #000;"></div>`
                    }</td>
                  </tr>
                `).join("")
              }
            </tbody>
          </table>
          <p style="margin-top:14px;font-size:10px;color:#6b7280;">${CONTACT_LINE}</p>
        </div>
      </body>
      </html>
    `);
    win.document.close();
    win.focus();
    setTimeout(()=>win.print(), 400);
  }
  wk_export.addEventListener("click", exportWeekly);

})();
</script>
</body>
</html>
