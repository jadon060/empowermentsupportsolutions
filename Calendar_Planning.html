<!-- ========== WEEKLY STAFF CALENDAR (PLANNED GOALS) ========== -->
<section id="weekly-plan" style="max-width:980px;margin:2rem auto;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06);border:1px solid #e5e7eb;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px;">
    <h2 style="margin:0;">ğŸ—“ï¸ Weekly Staff Calendar â€“ Planned Goals</h2>
    <span class="pill">For admin review</span>
  </div>

  <!-- fixed client like your other page -->
  <div class="row" style="margin-bottom:10px;">
    <input type="hidden" id="wk_client_id" value="521dd725-2fa6-4d78-9fcc-e5447dc727cb" />
    <div>
      <label class="label">Client</label>
      <input type="text" class="input" value="Omar V." readonly style="background:#e5e7eb;cursor:not-allowed;">
    </div>
    <div>
      <label for="wk_staff_name" class="label">Staff (type your name)</label>
      <input id="wk_staff_name" type="text" class="input" placeholder="e.g., John Perez" required />
    </div>
  </div>

  <!-- week selector -->
  <div class="weekbar" style="margin-bottom:14px;">
    <button id="wk_prevWeek" class="btn btn--icon">â—€</button>
    <div>
      <div id="wk_range" style="font-weight:700;color:#0f172a;">Mon â€” Sun</div>
      <div style="color:#6b7280;font-size:13px;">Week of <span id="wk_startTxt"></span> to <span id="wk_endTxt"></span></div>
    </div>
    <button id="wk_nextWeek" class="btn btn--icon">â–¶</button>
    <div class="spacer"></div>
  </div>

  <!-- all 7 days shown at once -->
  <div id="wk_daysGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;">
    <!-- JS will fill these -->
  </div>

  <!-- signature + submit -->
  <div class="sig-wrap" style="margin-top:16px;">
    <div class="sig-title">Staff Signature (for weekly plan)</div>
    <div class="sig-box">
      <canvas id="wk_staffSig" class="sig" style="width:100%;height:140px;display:block;border-radius:10px;touch-action:none;cursor:crosshair;"></canvas>
    </div>
    <button id="wk_clearSig" class="btn" style="margin-top:8px;">Clear Signature</button>
  </div>

  <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;">
    <button id="wk_saveDraft" class="btn">Save Draft</button>
    <button id="wk_submit" class="btn btn--primary">Submit Weekly Plan</button>
  </div>

  <div id="wk_error" style="display:none;margin-top:12px;padding:10px;border-radius:8px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b"></div>
  <div id="wk_toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.2);z-index:1000;font-size:14px;opacity:0;transition:opacity .25s"></div>
</section>

<script>
(function(){
  // reuse your same supabase project
  const SUPABASE_URL = "https://bqanjupmcgydvmfgvutx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYW5qdXBtY2d5ZHZtZmd2dXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTI4NzQsImV4cCI6MjA3NjM4ODg3NH0.J3A12rwUlSqjIsmlnNCcwis6Qt_ryw7ZzFqLftuMKUk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const ess = sb.schema("ess");

  const $ = id => document.getElementById(id);

  const wk_client_id = $("wk_client_id");
  const wk_staff_name = $("wk_staff_name");
  const wk_prevWeek = $("wk_prevWeek");
  const wk_nextWeek = $("wk_nextWeek");
  const wk_range = $("wk_range");
  const wk_startTxt = $("wk_startTxt");
  const wk_endTxt = $("wk_endTxt");
  const wk_daysGrid = $("wk_daysGrid");
  const wk_submit = $("wk_submit");
  const wk_saveDraft = $("wk_saveDraft");
  const wk_error = $("wk_error");
  const wk_toast = $("wk_toast");

  const sigCanvas = $("wk_staffSig");
  const clearSigBtn = $("wk_clearSig");
  let sigCtx, sigData = null;

  // ===== date helpers =====
  const fmt = d => new Intl.DateTimeFormat("en-US",{month:"short",day:"2-digit",year:"numeric"}).format(d);
  const ymd = d => d.toISOString().slice(0,10);
  function startOfWeekMonday(d){
    const nd=new Date(d.getFullYear(),d.getMonth(),d.getDate());
    const day=nd.getDay();
    const diff=(day===0?-6:1-day);
    nd.setDate(nd.getDate()+diff);
    nd.setHours(0,0,0,0);
    return nd;
  }
  function addDays(d,n){ const nd=new Date(d); nd.setDate(nd.getDate()+n); return nd; }

  // ===== signature setup =====
  function initSig(existing){
    const box = sigCanvas.getBoundingClientRect();
    const ratio = window.devicePixelRatio || 1;
    const width = Math.max(1, box.width);
    const height = 140;
    sigCanvas.width = width * ratio;
    sigCanvas.height = height * ratio;
    sigCtx = sigCanvas.getContext("2d");
    sigCtx.setTransform(1,0,0,1,0,0);
    sigCtx.scale(ratio, ratio);
    sigCtx.lineWidth = 2;
    sigCtx.lineCap = "round";
    sigCtx.strokeStyle = "#000";
    if (existing){
      const img = new Image();
      img.onload = ()=> sigCtx.drawImage(img,0,0,width,height);
      img.src = existing;
    }
  }
  initSig(null);

  function makeDrawable(canvas, ctx, onEnd){
    let drawing=false;
    function pos(e){
      const r=canvas.getBoundingClientRect();
      const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left;
      const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top;
      return {x,y};
    }
    function down(e){ e.preventDefault(); drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); }
    function move(e){ if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); }
    function up(){ if(!drawing) return; drawing=false; if(onEnd) onEnd(canvas); }
    canvas.addEventListener("pointerdown",down);
    canvas.addEventListener("pointermove",move);
    window.addEventListener("pointerup",up);
    canvas.addEventListener("touchstart",down,{passive:false});
    canvas.addEventListener("touchmove",move,{passive:false});
    canvas.addEventListener("touchend",up);
  }
  makeDrawable(sigCanvas, sigCtx, c => { sigData = c.toDataURL("image/png"); });

  clearSigBtn.addEventListener("click",()=>{
    sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height);
    sigData = null;
  });

  window.addEventListener("resize", ()=>{ initSig(sigData); });

  // ===== staff id helper (same idea as your daily form) =====
  const staffUuidCache = new Map();
  function isUuid(s){ return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s); }

  async function getOrCreateStaffUuid(){
    const name = (wk_staff_name.value || "").trim();
    if (!name) return null;
    if (isUuid(name)) return name;
    if (staffUuidCache.has(name)) return staffUuidCache.get(name);

    // try exact
    let { data, error } = await ess.from("staff").select("id, full_name").eq("full_name", name).maybeSingle();
    if (!error && data?.id){
      staffUuidCache.set(name, data.id);
      return data.id;
    }

    // create new
    const newId = (crypto && crypto.randomUUID) ? crypto.randomUUID() :
      'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
        const r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16);
      });
    const ins = await ess.from("staff").insert([{ id:newId, full_name:name }]).select("id").maybeSingle();
    const resolved = ins.data?.id || newId;
    staffUuidCache.set(name, resolved);
    return resolved;
  }

  // ===== week UI =====
  let currentWeekStart = startOfWeekMonday(new Date());
  const dayNames = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  function renderWeekUI(){
    const start = new Date(currentWeekStart);
    const end = addDays(start,6);
    wk_range.textContent = `Mon ${start.getDate()} â€” Sun ${end.getDate()}`;
    wk_startTxt.textContent = fmt(start);
    wk_endTxt.textContent = fmt(end);

    wk_daysGrid.innerHTML = "";
    for (let i=0;i<7;i++){
      const d = addDays(start,i);
      const card = document.createElement("div");
      card.style.border = "1px solid #e5e7eb";
      card.style.borderRadius = "12px";
      card.style.padding = "10px";
      card.style.background = "#f8fafc";

      card.innerHTML = `
        <div style="font-size:12px;color:#6b7280;">${dayNames[i]} â€” ${fmt(d)}</div>
        <label class="label" style="margin-top:6px;">Planned activities / goals</label>
        <textarea data-day="${i}" class="textarea" placeholder="â€¢ work on money mgmt
â€¢ housekeeping task
â€¢ community outing" style="min-height:120px;"></textarea>
      `;
      wk_daysGrid.appendChild(card);
    }

    // after drawing, try to load existing week data
    loadWeekFromServer();
  }

  async function loadWeekFromServer(){
    wk_error.style.display = "none";
    const staffUuid = await getOrCreateStaffUuid();
    if (!staffUuid) return; // no staff typed yet
    const weekStartStr = ymd(currentWeekStart);

    const { data, error } = await ess.from("weekly_staff_plans")
      .select("*")
      .eq("client_id", wk_client_id.value)
      .eq("staff_id", staffUuid)
      .eq("week_start", weekStartStr)
      .maybeSingle();

    if (error){
      console.warn(error);
      return;
    }
    if (data){
      // fill textareas
      const texts = {
        0: data.mon_text || "",
        1: data.tue_text || "",
        2: data.wed_text || "",
        3: data.thu_text || "",
        4: data.fri_text || "",
        5: data.sat_text || "",
        6: data.sun_text || "",
      };
      wk_daysGrid.querySelectorAll("textarea[data-day]").forEach(t => {
        const idx = Number(t.dataset.day);
        t.value = texts[idx] || "";
      });

      // restore signature
      if (data.staff_signature){
        sigData = data.staff_signature;
        initSig(sigData);
      }
    }
  }

  function gatherForm(){
    const out = {};
    wk_daysGrid.querySelectorAll("textarea[data-day]").forEach(t=>{
      const idx = Number(t.dataset.day);
      const val = t.value || "";
      if (idx === 0) out.mon_text = val;
      if (idx === 1) out.tue_text = val;
      if (idx === 2) out.wed_text = val;
      if (idx === 3) out.thu_text = val;
      if (idx === 4) out.fri_text = val;
      if (idx === 5) out.sat_text = val;
      if (idx === 6) out.sun_text = val;
    });
    return out;
  }

  function toast(msg){
    wk_toast.textContent = msg;
    wk_toast.style.opacity = "1";
    setTimeout(()=> wk_toast.style.opacity = "0", 1600);
  }

  async function saveWeeklyPlan(submit){
    wk_error.style.display = "none";

    const staffName = (wk_staff_name.value || "").trim();
    if (!staffName){
      toast("Type staff name first");
      return;
    }
    const staffUuid = await getOrCreateStaffUuid();
    if (!staffUuid){
      wk_error.style.display="block";
      wk_error.textContent="Could not resolve staff.";
      return;
    }

    const payload = gatherForm();
    const weekStartStr = ymd(currentWeekStart);

    const upsertBody = {
      client_id: wk_client_id.value,
      staff_id: staffUuid,
      week_start: weekStartStr,
      mon_text: payload.mon_text || null,
      tue_text: payload.tue_text || null,
      wed_text: payload.wed_text || null,
      thu_text: payload.thu_text || null,
      fri_text: payload.fri_text || null,
      sat_text: payload.sat_text || null,
      sun_text: payload.sun_text || null,
      staff_signature: sigData || null,
      submitted: !!submit
    };

    const { error } = await ess.from("weekly_staff_plans").upsert(upsertBody, { onConflict: "client_id,staff_id,week_start" });

    if (error){
      wk_error.style.display = "block";
      wk_error.textContent = "Save failed: " + error.message;
      toast("Save failed âŒ");
      return;
    }

    toast(submit ? "Weekly plan submitted âœ…" : "Draft saved âœ…");
  }

  wk_prevWeek.addEventListener("click", ()=>{ currentWeekStart = addDays(currentWeekStart, -7); renderWeekUI(); });
  wk_nextWeek.addEventListener("click", ()=>{ currentWeekStart = addDays(currentWeekStart, 7); renderWeekUI(); });
  wk_saveDraft.addEventListener("click", ()=> saveWeeklyPlan(false));
  wk_submit.addEventListener("click", ()=> saveWeeklyPlan(true));
  wk_staff_name.addEventListener("blur", ()=> loadWeekFromServer());

  renderWeekUI();
})();
</script>
