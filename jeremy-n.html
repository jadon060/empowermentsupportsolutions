<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ESS â€¢ Daily SDP Log (Jeremy)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html,body{margin:0;padding:0;background:#f7f7fb;color:#0f172a}
    *,*::before,*::after{box-sizing:border-box}

    /* â¬‡ï¸ staff reference card (bigger) */
    .about-wrap{
      max-width:980px;
      margin:1.5rem auto 0.5rem;
      display:flex;
      gap:14px;
      align-items:flex-start;
      padding:0 1.5rem;
    }
    .about-card{
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:14px;
      padding:18px 20px 20px;
      display:flex;
      gap:16px;
      width:100%;
      box-shadow:0 2px 10px rgba(0,0,0,0.04);
    }
    .about-avatar{
      width:96px;
      height:96px;
      border-radius:999px;
      object-fit:cover;
      border:3px solid #eef2ff;
      background:#e5e7eb;
      flex:0 0 auto;
    }
    .about-body h3{
      margin:0 0 6px;
      font-size:1.25rem;
    }
    .about-body small{
      display:block;
      color:#6b7280;
      margin-bottom:10px;
      font-size:0.9rem;
    }
    .about-grid{
      display:flex;
      flex-wrap:wrap;
      gap:14px 32px;
    }
    .about-label{
      font-weight:650;
      font-size:13px;
      margin-bottom:4px;
      color:#0f172a;
    }
    .about-text{
      font-size:14px;
      line-height:1.5;
    }
    @media (max-width:700px){
      .about-wrap{padding:0 1rem;}
      .about-card{flex-direction:column;align-items:flex-start;}
      .about-avatar{width:80px;height:80px;}
    }

    /* ðŸ”— quick-link buttons */
    .quick-links{
      max-width:980px;
      margin:0 auto 0.75rem;
      padding:0 1.5rem;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .quick-link-btn{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:9px 14px;
      border-radius:999px;
      border:1px solid #1f2937;
      background:#111827;
      color:#f9fafb;
      font-size:.9rem;
      text-decoration:none;
      box-shadow:0 2px 6px rgba(15,23,42,.18);
      white-space:nowrap;
    }
    .quick-link-btn--secondary{
      background:#ffffff;
      color:#111827;
      border-color:#e5e7eb;
      box-shadow:0 1px 4px rgba(15,23,42,.10);
    }
    .quick-link-btn span:first-child{
      font-size:1rem;
    }
    @media (max-width:700px){
      .quick-links{padding:0 1rem;}
      .quick-link-btn{
        flex:1 1 100%;
        justify-content:center;
        white-space:normal;
        text-align:center;
      }
    }

    /* === existing styles (unchanged) === */
    .row{display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap}
    .row > *{min-width:240px;flex:1}
    .weekbar{display:flex;align-items:center;gap:12px;border:1px solid #e5e7eb;padding:10px;border-radius:10px;background:#f8fafc;flex-wrap:wrap}
    .weekbar .spacer{flex:1 1 auto;min-width:60px}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer}
    .btn--primary{border-color:#2c3e50;background:#2c3e50;color:#fff}
    .btn--icon{width:36px;height:36px}
    .daybtn{position:relative;border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;cursor:pointer;width:100%;text-align:left}
    .dot{position:absolute;right:10px;top:10px;width:8px;height:8px;border-radius:999px;background:#e5e7eb}
    .input,.select,.textarea{width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px}
    .textarea{min-height:120px;resize:vertical}
    .label{display:block;color:#6b7280;font-size:12px;margin-bottom:6px}
    .pill{font-size:12px;background:#eef2ff;border:1px solid #e5e7eb;padding:6px 10px;border-radius:999px;color:#0f172a}
    #w_toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111827;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.2);z-index:1000;font-size:14px;opacity:0;transition:opacity .25s}
    #w_error{display:none;margin-top:12px;padding:10px;border-radius:8px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b}
    .sig-wrap{background:#f3f4f6;border:1px solid #e5e7eb;border-radius:14px;padding:18px;margin-top:14px;}
    .sig-title{font-weight:600;margin-bottom:8px;}
    .sig-box{border:1px dashed #d1d5db;border-radius:10px;background:#fff;}
    canvas.sig{width:100%;height:140px;display:block;border-radius:10px;touch-action:none;cursor:crosshair;}
  </style>
</head>
<body>

<!-- â¬‡ï¸ staff reference -->
<div class="about-wrap">
  <div class="about-card">
    <img src="https://jadon060.github.io/empowermentsupportsolutions/Jeremy.jpg" alt="Jeremy profile photo" class="about-avatar" loading="lazy" />
    <div class="about-body">
      <h3>About Jeremy</h3>
      <small>Use this to connect before starting session â€” keep activities engaging and avoid family topics âœ…</small>
      <div class="about-grid">
        <div style="min-width:180px;">
          <div class="about-label">Favorites</div>
          <div class="about-text">
            Movie: <strong>Jurassic Park (1)</strong><br>
            Food: <strong>Cheeseburger, chicken quesadillas, chicken fried steak</strong><br>
            Music: <strong>Heavy metal</strong>
          </div>
        </div>
        <div style="min-width:180px;">
          <div class="about-label">Things he enjoys</div>
          <div class="about-text">
            Writing novels and playing action/horror games on the game console.
          </div>
        </div>
        <div style="min-width:180px;">
          <div class="about-label">Keep in mind</div>
          <div class="about-text">
            Jeremy gets upset when he is bored and may yell or AWOL.<br>
            Do <strong>not</strong> talk about family or his parents â€” this is a sensitive topic.
          </div>
        </div>
        <div style="min-width:180px;">
          <div class="about-label">Comfort tools</div>
          <div class="about-text">
            Talking about TV shows and taking a moment to pray to God helps him calm down.
          </div>
        </div>
        <div style="min-width:180px;">
          <div class="about-label">Quick notes for ESS</div>
          <div class="about-text">
            Keep sessions active and choice-based to prevent boredom.<br>
            Redirect from family topics to TV, games, or prayer when he is escalated.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ðŸ”— Jeremy quick-links bar -->
<div class="quick-links">
  <!-- ðŸ” FIXED: Now correctly links to Jeremy's calendar -->
  <a href="Jeremy_Calendar.html" class="quick-link-btn">
    <span>ðŸ“†</span>
    <span>Weekly staff calendar</span>
  </a>
  <a href="ESS%20%E2%80%A2%20Jeremy%20%E2%80%93%20Person-Centered%20Plan%20(PCP).pdf" class="quick-link-btn quick-link-btn--secondary">
    <span>ðŸ§ </span>
    <span>Jeremy PCP (Person-Centered Plan)</span>
  </a>
</div>

<section style="max-width:980px;margin:2rem auto;padding:1.5rem;background:#fff;border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,0.06);font-family:sans-serif;border:1px solid #e5e7eb;">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:8px;">
    <h2 style="margin:0;">ðŸ“… Daily SDP Log â€“ Jeremy</h2>
    <span class="pill">Daily submissions â†’ Admin export</span>
  </div>

  <!-- fixed client -->
  <div class="row" style="margin-bottom:10px;">
    <input type="hidden" id="client_id" value="e083501e-86d5-41e8-b840-c3ba5b6dc9c9" />
    <div>
      <label class="label">Client</label>
      <input type="text" class="input" value="Jeremy N." readonly style="background:#e5e7eb;cursor:not-allowed;">
    </div>
    <div>
      <label for="staff_id" class="label">Staff (type your name)</label>
      <input id="staff_id" type="text" class="input" placeholder="e.g., John Perez" required />
    </div>
  </div>

  <!-- week select -->
  <div class="weekbar">
    <button id="w_prevWeek" class="btn btn--icon">â—€</button>
    <div>
      <div id="w_range" style="font-weight:700;color:#0f172a;">Mon â€” Sun</div>
      <div style="color:#6b7280;font-size:13px;">Week of <span id="w_startTxt"></span> to <span id="w_endTxt"></span></div>
    </div>
    <button id="w_nextWeek" class="btn btn--icon">â–¶</button>
    <div class="spacer"></div>
  </div>

  <!-- days -->
  <div id="w_days" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:8px;margin-top:14px;"></div>

  <!-- day panel -->
  <div id="w_panel" style="display:none;margin-top:12px;border-top:1px solid #e5e7eb;padding-top:12px;">
    <div id="w_panelDate" style="color:#6b7280;margin-bottom:10px;"></div>

    <div class="row">
      <div>
        <label for="w_start" class="label">Start Time</label>
        <input id="w_start" type="time" class="input">
      </div>
      <div>
        <label for="w_end" class="label">End Time</label>
        <input id="w_end" type="time" class="input">
      </div>
      <div>
        <label for="w_modality" class="label">Modality / Location</label>
        <select id="w_modality" class="select">
          <option value="Home">Home</option>
          <option value="Community">Community</option>
          <option value="Remote" selected>Remote</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label for="w_hours" class="label">Hours Worked</label>
        <input id="w_hours" type="number" min="0" step="0.25" placeholder="e.g., 3.5" class="input">
      </div>
      <div>
        <label for="w_domain" class="label">Domain (service codes worked on)</label>
        <input id="w_domain" type="text" placeholder="e.g., Money Mgmt, Hygiene, Safetyâ€¦" class="input">
      </div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label for="w_rc" class="label">Regional Center</label>
        <input id="w_rc" type="text" class="input" placeholder="e.g., SCLARC">
      </div>
      <div>
        <label for="w_sc" class="label">Service Coordinator</label>
        <input id="w_sc" type="text" class="input" placeholder="e.g., Imani T.">
      </div>
    </div>

    <div style="margin-top:12px;">
      <label for="w_notes" class="label">Progress Notes</label>
      <textarea id="w_notes" class="textarea" placeholder="what/where/with whom, goals"></textarea>
    </div>

    <div style="margin-top:12px;">
      <label for="w_obs" class="label">Observation</label>
      <textarea id="w_obs" class="textarea" placeholder="reaction/response to today's services"></textarea>
    </div>

    <div style="margin-top:12px;">
      <label for="w_plan" class="label">Action Plan</label>
      <textarea id="w_plan" class="textarea" placeholder="next steps to work on the service codes"></textarea>
    </div>

    <div class="sig-wrap">
      <div style="display:flex;gap:20px;flex-wrap:wrap;">
        <div style="flex:1;min-width:240px;">
          <div class="sig-title">Staff Signature</div>
          <div class="sig-box">
            <canvas id="staffSig" class="sig"></canvas>
          </div>
          <div style="font-size:12px;color:#6b7280;margin-top:6px;">Draw with mouse/finger.</div>
          <button id="clearStaffSig" class="btn" style="margin-top:8px;">Clear Staff Signature</button>
        </div>
        <div style="flex:1;min-width:240px;">
          <div class="sig-title">Client / Parent / Authorized Signature</div>
          <div class="sig-box">
            <canvas id="clientSig" class="sig"></canvas>
          </div>
          <div style="font-size:12px;color:#6b7280;margin-top:6px;">Draw with mouse/finger.</div>
          <button id="clearClientSig" class="btn" style="margin-top:8px;">Clear Client Signature</button>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px;">
      <button id="w_submitDay" class="btn btn--primary">Submit Day (Official)</button>
    </div>
  </div>

  <div id="w_error"></div>
  <div id="w_toast"></div>
</section>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const SUPABASE_URL = "https://bqanjupmcgydvmfgvutx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJxYW5qdXBtY2d5ZHZtZmd2dXR4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4MTI4NzQsImV4cCI6MjA3NjM4ODg3NH0.J3A12rwUlSqjIsmlnNCcwis6Qt_ryw7ZzFqLftuMKUk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const ess = sb.schema("ess");

  const $ = (id) => document.getElementById(id);

  const CLIENT_ID_INPUT = $("client_id");
  const STAFF_INPUT     = $("staff_id");

  const w_days=$("w_days"), w_range=$("w_range"), w_startTxt=$("w_startTxt"), w_endTxt=$("w_endTxt");
  const w_prevWeek=$("w_prevWeek"), w_nextWeek=$("w_nextWeek");
  const w_panel=$("w_panel"), w_panelDate=$("w_panelDate");
  const w_start=$("w_start"), w_end=$("w_end"), w_modality=$("w_modality");
  const w_hours=$("w_hours"), w_domain=$("w_domain"), w_notes=$("w_notes");
  const w_obs=$("w_obs"), w_plan=$("w_plan");
  const w_rc=$("w_rc"), w_sc=$("w_sc");
  const w_submitDay=$("w_submitDay");
  const w_toast=$("w_toast"), w_error=$("w_error");

  const staffSigCanvas = $("staffSig");
  const clientSigCanvas = $("clientSig");
  let staffSigData = null, clientSigData = null;

  function initSignatureCanvas(canvas, existingDataUrl){
    const box = canvas.getBoundingClientRect();
    const ratio = window.devicePixelRatio || 1;
    const width = Math.max(1, box.width);
    const height = 140;
    canvas.width  = width * ratio;
    canvas.height = height * ratio;
    const ctx = canvas.getContext("2d");
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(ratio, ratio);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.strokeStyle = "#000";
    if (existingDataUrl){
      const img = new Image();
      img.onload = () => ctx.drawImage(img, 0, 0, width, height);
      img.src = existingDataUrl;
    }
    return ctx;
  }

  let staffSigCtx = initSignatureCanvas(staffSigCanvas, null);
  let clientSigCtx = initSignatureCanvas(clientSigCanvas, null);

  function makeDrawable(canvas, ctx, onEnd){
    let drawing = false;
    function getPos(e){
      const r = canvas.getBoundingClientRect();
      const x = (e.touches ? e.touches[0].clientX : e.clientX) - r.left;
      const y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
      return {x,y};
    }
    function down(e){ e.preventDefault(); drawing = true; const p=getPos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); }
    function move(e){ if(!drawing) return; const p=getPos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); }
    function up(){ if(!drawing) return; drawing=false; if(onEnd) onEnd(canvas); }
    canvas.addEventListener("pointerdown", down);
    canvas.addEventListener("pointermove", move);
    window.addEventListener("pointerup", up);
    canvas.addEventListener("touchstart", down, {passive:false});
    canvas.addEventListener("touchmove", move, {passive:false});
    canvas.addEventListener("touchend", up);
  }

  function captureCanvasData(c){ return c.toDataURL("image/png"); }

  makeDrawable(staffSigCanvas, staffSigCtx, (c)=>{ staffSigData = captureCanvasData(c); });
  makeDrawable(clientSigCanvas, clientSigCtx, (c)=>{ clientSigData = captureCanvasData(c); });

  $("clearStaffSig").addEventListener("click",()=>{
    staffSigCtx.clearRect(0,0,staffSigCanvas.width,staffSigCanvas.height);
    staffSigData = null;
  });
  $("clearClientSig").addEventListener("click",()=>{
    clientSigCtx.clearRect(0,0,clientSigCanvas.width,clientSigCanvas.height);
    clientSigData = null;
  });

  window.addEventListener("resize", ()=>{
    if (w_panel.style.display !== "none") {
      staffSigCtx = initSignatureCanvas(staffSigCanvas, staffSigData);
      clientSigCtx = initSignatureCanvas(clientSigCanvas, clientSigData);
    }
  });

  function toast(m){w_toast.textContent=m;w_toast.style.opacity="1";setTimeout(()=>w_toast.style.opacity="0",1600);}

  const fmt = (d)=>new Intl.DateTimeFormat("en-US",{month:"short",day:"2-digit",year:"numeric"}).format(d);
  const ymd = (d)=>d.toISOString().slice(0,10);
  function startOfWeekMonday(d){const nd=new Date(d.getFullYear(),d.getMonth(),d.getDate());const day=nd.getDay();const diff=(day===0?-6:1-day);nd.setDate(nd.getDate()+diff);nd.setHours(0,0,0,0);return nd;}
  function addDays(d,n){const nd=new Date(d);nd.setDate(nd.getDate()+n);return nd;}

  const getClientId  = ()=> CLIENT_ID_INPUT.value;
  const getStaffName = ()=> (STAFF_INPUT.value || "").replace(/\s+/g,' ').trim();
  const isUuid = (s)=>/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(s);

  const staffUuidCache = new Map();

  async function getOrCreateStaffUuid() {
    const nameOrId = getStaffName();
    if (!nameOrId) return null;
    if (isUuid(nameOrId)) return nameOrId;
    if (staffUuidCache.has(nameOrId)) return staffUuidCache.get(nameOrId);

    // exact
    let { data, error } = await ess.from("staff").select("id, full_name").eq("full_name", nameOrId).maybeSingle();
    if (!error && data?.id) {
      staffUuidCache.set(nameOrId, data.id);
      return data.id;
    }

    // ilike
    ({ data, error } = await ess.from("staff").select("id, full_name").ilike("full_name", `%${nameOrId}%`).limit(1).maybeSingle());
    if (!error && data?.id) {
      staffUuidCache.set(nameOrId, data.id);
      return data.id;
    }

    // create
    const newId = (crypto && crypto.randomUUID) ? crypto.randomUUID() :
      'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,c=>{
        const r=Math.random()*16|0, v=c==='x'?r:(r&0x3|0x8); return v.toString(16);
      });

    const insert = await ess.from("staff").insert([{ id: newId, full_name: nameOrId }]).select("id").maybeSingle();
    if (insert.error) throw new Error(`Could not add staff "${nameOrId}". (${insert.error.message})`);

    const resolved = insert.data?.id || newId;
    staffUuidCache.set(nameOrId, resolved);
    return resolved;
  }

  let current = startOfWeekMonday(new Date());
  let activeIndex = null;

  async function fetchServerDay(i){
    const staffUuid = await getOrCreateStaffUuid();
    if (!staffUuid) return null;
    const dayDate = ymd(addDays(current,i));

    // official first
    let { data: official } = await ess.from("daily_entries")
      .select("*")
      .eq("client_id", getClientId())
      .eq("staff_id", staffUuid)
      .eq("service_date", dayDate)
      .maybeSingle();

    if (official) {
      return {
        source: "official",
        hours: (official.hours !== undefined && official.hours !== null) ? official.hours : null,
        activities: Array.isArray(official.activities) ? official.activities.join(", ") : (official.activities || ""),
        notes: official.service_notes || "",
        start_time: official.start_time || "",
        end_time: official.end_time || "",
        modality: official.modality || "Remote",
        staff_signature: official.staff_signature || null,
        client_signature: official.client_signature || null,
        regional_center: official.regional_center || "",
        service_coordinator: official.service_coordinator || "",
        date: dayDate
      };
    }

    // draft
    let { data: draft } = await ess.from("daily_drafts")
      .select("*")
      .eq("client_id", getClientId())
      .eq("staff_id", staffUuid)
      .eq("date", dayDate)
      .maybeSingle();

    if (draft) {
      return {
        source: "draft",
        hours: draft.hours ?? null,
        activities: draft.activities || "",
        notes: draft.notes || "",
        start_time: draft.start_time || "",
        end_time: draft.end_time || "",
        modality: draft.modality || "Remote",
        staff_signature: draft.staff_signature || null,
        client_signature: draft.client_signature || null,
        regional_center: draft.regional_center || "",
        service_coordinator: draft.service_coordinator || "",
        date: dayDate
      };
    }

    return null;
  }

  async function markDotsFromServer(){
    for (let i=0;i<7;i++){
      const dot = document.getElementById("w_dot"+i);
      if (!dot) continue;
      const staff = getStaffName();
      if (!staff){
        dot.style.background = "#e5e7eb";
        continue;
      }
      const srv = await fetchServerDay(i);
      dot.style.background = srv ? "#22c55e" : "#e5e7eb";
    }
  }

  function renderWeek(){
    const start=new Date(current), end=addDays(start,6);
    end.setHours(23,59,59,999);
    w_startTxt.textContent=fmt(start); w_endTxt.textContent=fmt(end);
    w_range.textContent=`Mon ${start.getDate()} â€” Sun ${end.getDate()}`;
    const names=['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
    w_days.innerHTML='';
    for(let i=0;i<7;i++){
      const d = addDays(start,i);
      const btn = document.createElement('button');
      btn.type='button';
      btn.className='daybtn';
      btn.innerHTML=`
        <div style="font-size:12px;color:#6b7280;">${names[i]}</div>
        <div style="font-size:16px;font-weight:800;color:#0f172a;">${d.getDate()}</div>
        <div id="w_dot${i}" class="dot"></div>
      `;
      btn.addEventListener('click',()=>openDay(i));
      w_days.appendChild(btn);
    }
    const today=new Date();
    const inRange=+today>=+start && +today<=+end;
    openDay(inRange ? (today.getDay()===0?6:today.getDay()-1) : 0);
    setTimeout(markDotsFromServer, 200);
  }

  function parseMergedNotes(text){
    const out = { notes:'', obs:'', plan:'' };
    if(!text) return out;
    const N='## Progress Notes:', O='## Observation:', P='## Action Plan:';
    if(text.includes(N)){
      const nIdx=text.indexOf(N)+N.length;
      const oIdx=text.indexOf(O, nIdx);
      const pIdx=text.indexOf(P, oIdx>-1?oIdx:nIdx);
      out.notes = text.slice(nIdx, oIdx>-1?oIdx:(pIdx>-1?pIdx:text.length)).trim();
      if (oIdx>-1) out.obs = text.slice(oIdx+O.length, pIdx>-1?pIdx:text.length).trim();
      if (pIdx>-1) out.plan = text.slice(pIdx+P.length).trim();
      return out;
    }
    out.notes = text;
    return out;
  }

  function mergeNotes(notes, obs, plan){
    return [
      "## Progress Notes:\n" + (notes||"").trim(),
      "## Observation:\n" + (obs||"").trim(),
      "## Action Plan:\n" + (plan||"").trim(),
    ].join("\n\n").trim();
  }

  async function openDay(i){
    activeIndex=i;
    w_error.style.display='none';
    [...w_days.children].forEach((el,idx)=>{ el.style.outline=(idx===i)?'2px solid #0ea5e9':'none'; });

    const d=addDays(current,i);
    w_panelDate.textContent=`${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'][i]} â€” ${fmt(d)}`;
    w_panel.style.display='block';

    const srv = await fetchServerDay(i);
    if (srv){
      const parsed = parseMergedNotes(srv.notes || "");
      w_hours.value = srv.hours ?? '';
      w_domain.value= srv.activities ?? '';
      w_notes.value = parsed.notes ?? '';
      w_obs.value   = parsed.obs ?? '';
      w_plan.value  = parsed.plan ?? '';
      w_start.value = srv.start_time ?? '';
      w_end.value   = srv.end_time ?? '';
      w_modality.value = srv.modality ?? 'Remote';
      w_rc.value = srv.regional_center ?? '';
      w_sc.value = srv.service_coordinator ?? '';

      staffSigData = srv.staff_signature || null;
      clientSigData = srv.client_signature || null;
      staffSigCtx  = initSignatureCanvas(staffSigCanvas,  staffSigData);
      clientSigCtx = initSignatureCanvas(clientSigCanvas, clientSigData);
    } else {
      w_hours.value=w_domain.value=w_notes.value=w_obs.value=w_plan.value=w_start.value=w_end.value='';
      w_modality.value='Remote';
      w_rc.value='';
      w_sc.value='';
      staffSigData=null;
      clientSigData=null;
      staffSigCtx  = initSignatureCanvas(staffSigCanvas,  null);
      clientSigCtx = initSignatureCanvas(clientSigCanvas, null);
    }
  }

  function buildPayload(){
    const notesMerged = mergeNotes((w_notes.value||''),(w_obs.value||''),(w_plan.value||''));
    return {
      date: ymd(addDays(current,activeIndex)),
      hours: (w_hours.value||''),
      activities: (w_domain.value||''),
      notes: notesMerged,
      start_time: (w_start.value||''),
      end_time: (w_end.value||''),
      modality: (w_modality.value||'Remote'),
      regional_center: (w_rc.value || ''),
      service_coordinator: (w_sc.value || ''),
      staff_signature: staffSigData || null,
      client_signature: clientSigData || null
    };
  }

  async function submitDay(){
    if (activeIndex == null) return;
    if (!getStaffName()){ toast("Type staff name first"); return; }

    const payload = buildPayload();

    let staffUuid;
    try {
      staffUuid = await getOrCreateStaffUuid();
    } catch (e) {
      w_error.style.display='block';
      w_error.textContent = e.message;
      toast('Staff error âŒ');
      return;
    }

    // try insert WITH hours
    const baseEntry = {
      client_id: getClientId(),
      staff_id: staffUuid,
      service_date: payload.date,
      start_time: payload.start_time || null,
      end_time: payload.end_time || null,
      modality: payload.modality || 'Remote',
      service_notes: payload.notes || null,
      activities: payload.activities ? [payload.activities] : null,
      staff_signature: payload.staff_signature || null,
      client_signature: payload.client_signature || null,
      regional_center: payload.regional_center || null,
      service_coordinator: payload.service_coordinator || null,
      signed_at: new Date().toISOString(),
      hours: payload.hours !== '' ? Number(payload.hours) : null
    };

    let { error } = await ess.from("daily_entries").insert(baseEntry);

    if (error && (error.message || '').toLowerCase().includes("could not find the 'hours' column")) {
      const { error: e2 } = await ess.from("daily_entries").insert({
        ...baseEntry,
        hours: undefined
      });
      if (e2) {
        w_error.style.display='block';
        w_error.textContent = 'Submit failed: ' + e2.message;
        toast('Submit failed âŒ');
        return;
      }
    } else if (error && String(error.message||'').includes('activities_allowed')) {
      const { error: e3 } = await ess.from("daily_entries").insert({
        ...baseEntry,
        activities: null
      });
      if (e3) {
        w_error.style.display='block';
        w_error.textContent = 'Submit failed: ' + e3.message;
        toast('Submit failed âŒ');
        return;
      }
    } else if (error) {
      w_error.style.display='block';
      w_error.textContent = 'Submit failed: ' + error.message;
      toast('Submit failed âŒ');
      return;
    }

    await ess.from("daily_drafts").upsert({
      client_id: getClientId(),
      staff_id: staffUuid,
      week_start: ymd(current),
      day_index: activeIndex,
      date: payload.date,
      hours: payload.hours !== '' ? Number(payload.hours) : null,
      activities: payload.activities || null,
      notes: payload.notes || null,
      start_time: payload.start_time || null,
      end_time: payload.end_time || null,
      modality: payload.modality || 'Remote',
      staff_signature: payload.staff_signature || null,
      client_signature: payload.client_signature || null,
      regional_center: payload.regional_center || null,
      service_coordinator: payload.service_coordinator || null,
      submitted: true
    }, { onConflict: "client_id,staff_id,week_start,day_index" });

    toast('Day submitted (official) âœ…');
    setTimeout(markDotsFromServer, 200);
  }

  function shiftWeek(delta){ current=addDays(current,7*delta); renderWeek(); }

  w_prevWeek.addEventListener('click',()=>shiftWeek(-1));
  w_nextWeek.addEventListener('click',()=>shiftWeek(1));
  w_submitDay.addEventListener('click',submitDay);

  renderWeek();
});
</script>
</body>
</html>
